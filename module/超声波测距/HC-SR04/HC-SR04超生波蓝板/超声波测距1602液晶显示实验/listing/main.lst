C51 COMPILER V9.00   MAIN                                                                  06/09/2013 02:54:14 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN ..\out\main.obj
COMPILER INVOKED BY: d:\Keil c51\C51\BIN\C51.EXE ..\user\main.c BROWSE DEBUG OBJECTEXTEND PRINT(..\listing\main.lst) OBJ
                    -ECT(..\out\main.obj)

line level    source

   1          /**********************HL-1实验开发板例程************************
   2          *       
   3          *               文件名称：led.c
   4          *               功能描述：本例程为超声波测距的学习。使用前先根据超声波模块的IO修改本程序的端口定义。
   5          *                                       本例程为网络资料搜集整理 。
   6          *
   7          *
   8          *               使用环境：TS-51A开发板 + STC89C52 + 11.0592M晶振 + Keil C51 V9.0 
   9          *       
  10          *               淘宝地址：http://shop104208028.taobao.com/
  11          *               QQ      : 10903659
  12          *               QQ群    ：336397723  336398729   336398900
  13          ******************************************************************/
  14          /**********************************包含头文件**********************************/
  15          #include <reg52.h>
  16          #include "1602.h"
  17          /************************************宏定义************************************/
  18          #define VELOCITY_30C    3495       //30摄氏度时的声速，声速V= 331.5 + 0.6*温度； 
  19          #define VELOCITY_23C    3453       //23摄氏度时的声速，声速V= 331.5 + 0.6*温度； 
  20          /************************************位定义************************************/
  21          sbit INPUT  = P3^2;                //回声接收端口
  22          sbit OUTPUT = P1^4;                //超声触发端口
  23          sbit Beep   = P2^2;                        // 蜂鸣器　
  24          /********************************定义变量和数组********************************/
  25          long int distance=0;               //距离变量
  26          uchar table[]  = "                ";
  27          uchar table0[] = "    TS-51A      ";
  28          uchar table1[] = "There's no echo.";
  29          uchar table2[] = "    TS-51A      ";
  30          uchar table3[] = "Distance:";
  31          uchar count;
  32          /***********************************函数声明***********************************/
  33          extern void initLCD();
  34          extern void write_date(uchar date);
  35          extern void write_com(uchar com);
  36          extern void delay(uint x);
  37          /******************************************************************************/
  38          /* 函数名称  : Delay_xMs                                                      */
  39          /* 函数描述  : 延时函数                                                       */
  40          /* 输入参数  : x                                                              */
  41          /* 参数描述  : 延时时间                                                       */
  42          /* 返回值    : 无                                                             */
  43          /******************************************************************************/
  44          void Delay_xMs(unsigned int x)
  45          {
  46   1          unsigned int i,j;
  47   1          for(i = 0;i < x;i++ )
  48   1          {
  49   2              for(j = 0;j < 3;j++ )
  50   2              {
  51   3                  ;
  52   3              }
  53   2          }
  54   1      }
C51 COMPILER V9.00   MAIN                                                                  06/09/2013 02:54:14 PAGE 2   

  55          /******************************************************************************/
  56          /* 函数名称  : Alarm                                                          */
  57          /* 函数描述  : 蜂鸣器发声函数                                                 */
  58          /* 输入参数  : t                                                              */
  59          /* 参数描述  : 发声的次数                                                     */
  60          /* 返回值    : 无                                                             */
  61          /******************************************************************************/
  62          void Alarm(uchar t)
  63          {
  64   1              uchar i;
  65   1              for(i = 0;i < t;i++)
  66   1              {
  67   2                      Beep = 0;
  68   2                      Delay_xMs(1000);
  69   2                      Beep = 1;
  70   2                      Delay_xMs(1000);
  71   2              }
  72   1      }       
  73          /******************************************************************************/
  74          /* 函数名称  : delayt                                                         */
  75          /* 函数描述  : 延时函数                                                       */
  76          /* 输入参数  : x                                                              */
  77          /* 参数描述  : 延时时间数据                                                   */
  78          /* 返回值    : 无                                                             */
  79          /******************************************************************************/        
  80          void delayt(uint x)
  81          {
  82   1          uchar j;
  83   1          while(x-- > 0)
  84   1          {
  85   2                  for(j = 0;j < 125;j++)
  86   2              {
  87   3                  ;
  88   3              }
  89   2          }
  90   1      }
  91          /******************************************************************************/
  92          /* 函数名称  : Init_MCU                                                       */
  93          /* 函数描述  : 初始化单片机函数                                               */
  94          /* 输入参数  : 无                                                             */
  95          /* 参数描述  : 无                                                             */
  96          /* 返回值    : 无                                                             */
  97          /******************************************************************************/
  98          void Init_MCU(void)
  99          {
 100   1              TMOD = 0x01;      //定时器2初始化,设置为16位自动重装模式
 101   1              TL0 = 0x66;
 102   1              TH0 = 0xfc;           //1ms
 103   1          ET0 = 1;          //开定时器2
 104   1              EA = 1;               //总中断使能
 105   1      }
 106          /******************************************************************************/
 107          /* 函数名称  : Init_Parameter                                                 */
 108          /* 函数描述  : 初始化参数和IO口函数                                           */
 109          /* 输入参数  : 无                                                             */
 110          /* 参数描述  : 无                                                             */
 111          /* 返回值    : 无                                                             */
 112          /******************************************************************************/
 113          void Init_Parameter(void)
 114          {
 115   1               OUTPUT =1;
 116   1               INPUT = 1;
C51 COMPILER V9.00   MAIN                                                                  06/09/2013 02:54:14 PAGE 3   

 117   1               count = 0;
 118   1               distance = 0;
 119   1      }
 120          /******************************************************************************/
 121          /* 函数名称  : display_char                                                   */
 122          /* 函数描述  : 显示字符串函数                                                 */
 123          /* 输入参数  : point,address                                                  */
 124          /* 参数描述  : 写入的字符串的地址指针 1602显示对应的地址                      */
 125          /* 返回值    : 无                                                             */
 126          /******************************************************************************/
 127          void display_char(uchar *point,uchar address)
 128          {
 129   1              uchar i;
 130   1              write_com(0x80 + address);
 131   1              for(i = 0;i < 16; i++)
 132   1              {
 133   2                      write_date(*point);
 134   2                      point++;
 135   2              }
 136   1      }
 137          /******************************************************************************/
 138          /* 函数名称  : display                                                        */
 139          /* 函数描述  : 显示数字                                                       */
 140          /* 输入参数  : number，address                                                */
 141          /* 参数描述  : number写入的数据，address地址                                  */
 142          /* 返回值    : 无                                                             */
 143          /******************************************************************************/        
 144          void display(int number,uchar address)
 145          {
 146   1              uchar b,c,d,e;
 147   1              b= (number / 1000);
 148   1              c= (number / 100) % 10;
 149   1              d = (number / 10) % 10;
 150   1              e = number % 10;
 151   1      
 152   1              write_com(0x80 + address);
 153   1          write_date(b + 48);
 154   1              write_date(c + 48);
 155   1              write_date(d + 48);
 156   1              write_date(46);           //小数点的ASCII
 157   1              write_date(e + 48);
 158   1          write_date(99);           //"c"的ASCII
 159   1              write_date(109);          //"m"的ASCII
 160   1      }
 161          /******************************************************************************/
 162          /* 函数名称  : Trig_SuperSonic                                                */
 163          /* 函数描述  : 发出声波函数                                                   */
 164          /* 输入参数  : 无                                                             */
 165          /* 参数描述  : 无                                                             */
 166          /* 返回值    : 无                                                             */
 167          /******************************************************************************/
 168          void Trig_SuperSonic(void)//出发声波
 169          {
 170   1               OUTPUT = 1;
 171   1               delayt(1);
 172   1               OUTPUT = 0;
 173   1      }
 174          /******************************************************************************/
 175          /* 函数名称  : Measure_Distance                                               */
 176          /* 函数描述  : 计算距离函数                                                   */
 177          /* 输入参数  : 无                                                             */
 178          /* 参数描述  : 无                                                             */
C51 COMPILER V9.00   MAIN                                                                  06/09/2013 02:54:14 PAGE 4   

 179          /* 返回值    : 无                                                             */
 180          /******************************************************************************/
 181          void Measure_Distance(void)
 182          {
 183   1              uchar l;
 184   1              uint h,y;
 185   1              TR0 = 1;
 186   1              while(INPUT)
 187   1          {
 188   2              ;
 189   2          }   
 190   1              TR0 = 0;
 191   1              l = TL0;
 192   1              h = TH0;
 193   1              y = (h << 8) + l;
 194   1              y = y - 0xfc66;//us部分
 195   1              distance = y + 1000 * count;//计算总时间
 196   1              TL0 = 0x66;
 197   1              TH0 = 0xfc;
 198   1              delayt(30);
 199   1              distance = VELOCITY_30C * distance / 20000;
 200   1      }
 201          /******************************************************************************/
 202          /* 函数名称  : main                                                           */
 203          /* 函数描述  : 主函数                                                         */
 204          /* 输入参数  : 无                                                             */
 205          /* 参数描述  : 无                                                             */
 206          /* 返回值    : 无                                                             */
 207          /******************************************************************************/                                        
 208          void main(void)
 209          {       
 210   1          rw = 0;
 211   1              initLCD();
 212   1              Init_MCU();
 213   1              Init_Parameter();
 214   1              Alarm(2);
 215   1              display_char(table,0x00);
 216   1              display_char(table0,0x40);
 217   1              Delay_xMs(30000);
 218   1              display_char(table2,0x00);
 219   1              display_char(table1,0x40);
 220   1      
 221   1              while(1)
 222   1              {
 223   2                       Trig_SuperSonic();         //触发超声波发射
 224   2                       while(INPUT == 0)          //等待回声
 225   2               {
 226   3                   ;
 227   3               }
 228   2                       Measure_Distance();        //计算脉宽并转换为距离
 229   2                       display_char(table3,0x40);
 230   2                       display(distance,0x49);    //显示距离
 231   2                       Init_Parameter();          // 参数重新初始化
 232   2                       delayt(100);               //延时，两次发射之间要至少有10ms间隔
 233   2               }      
 234   1      }
 235          /******************************************************************************/
 236          /* 函数名称  : timer0                                                         */
 237          /* 函数描述  : T0中断处理函数                                                 */
 238          /* 输入参数  : 无                                                             */
 239          /* 参数描述  : 无                                                             */
 240          /* 返回值    : 无                                                             */
C51 COMPILER V9.00   MAIN                                                                  06/09/2013 02:54:14 PAGE 5   

 241          /******************************************************************************/
 242          void timer0 (void) interrupt 1
 243          {
 244   1              TF0 = 0;
 245   1              TL0 = 0x66;
 246   1              TH0 = 0xfc;
 247   1              count++;
 248   1              if(count == 18)//超声波回声脉宽最多18ms
 249   1              {
 250   2                      TR0 =0;
 251   2                      TL0 = 0x66;
 252   2                      TH0 = 0xfc;
 253   2                      count = 0;
 254   2              }
 255   1      }
 256          /******************************************************************************/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    644    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     83       6
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
