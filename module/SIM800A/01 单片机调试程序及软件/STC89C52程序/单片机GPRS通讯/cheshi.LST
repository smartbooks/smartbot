C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 1   


C51 COMPILER V7.50, COMPILATION OF MODULE CHESHI
OBJECT MODULE PLACED IN cheshi.OBJ
COMPILER INVOKED BY: d:\Keil\C51\BIN\C51.EXE cheshi.C COMPACT BROWSE DEBUG OBJECTEXTEND

line level    source

   1          
   2          #include <cheshi.h>
   3          uchar data int_case;    //ÖÐ¶Ï±êÖ¾
   4          #define MAX_TM   185         // ATÖ¸ÊÕ·¢Êý×é×î´ó»º³å
   5          #define MAX_T  60
   6          uchar idata uart_buff[MAX_TM]; //Í¨ÐÅ³ÌÐòÖÐµÄ»º³å
   7          char idata  receive_count;    //·¢ËÍ  Êý×éÖ¸Õë
   8           
   9          #if  CPU_TYPE2==STC89E58
  10          uchar idata  pc_bit  ;  //´®¿Ú2½ÓÊÕÖÐ¶Ï
  11          uchar xdata pc_buff[MAX_TM];
  12          char idata  pc_count;
  13            #endif
  14          
  15          
  16          uchar xdata para_temp[MAX_T];     //¶àÓÃÁÙÊ±ÓÃ
  17          uchar data read_tmp;             ///¶Áµç»°±¾ºÅ²ÎÊý
  18          uchar data sms_num_tmp;                 ///¶Á¶ÌÐÅºÅÂë²ÎÊý
  19          
  20          uchar data sms_tmp;                     ///¶ÌÐÅ´¦Àí²ÎÊý´úÂë
  21          uchar xdata TEL_temp[20];   //´æ¶Ô·½ºÅÂë£¬
  22          uchar xdata GPRS_TMP[32];     //¶àÓÃÁÙÊ±ÓÃ
  23          //#define IO_OUT                        P3_6
  24          //#define GPS_ON                        P1_1 //GPS¿ª¹Ø
  25          uchar data system_server ;    //ÏµÍ³×´Ì¬
  26          
  27          //£­£­£­¶¨Ê±ÓÃ£­£­£­£­£­£­£­£­£­£­£­
  28          uint  data timercount;          //50MS¶¨Ê±Æ÷,
  29          uchar data timer_1S_cnt;
  30          uchar data timer_10S_cnt;
  31          uchar data timer_S_cnt;
  32          
  33          
  34          
  35          
  36          //--------------------
  37          uchar xdata LED_P0;
  38          uchar data ring_cnt;    //ÕñÁåÓÃ
  39           bit ring_bit  ;  // µç»°ºôÈë¡¡2
  40          //------------------------------
  41          uchar xdata PT2272_BUF;//´æ´¢ÓÃ
  42          bit PT2272_BIT;   //315M-ÊÇ·ñÁ¬½áµ½Éè±¸ÉÏ
  43          uchar bdata PT2272_TMP;  //ÎÞÏß¿ØÖÆ
  44          sbit PT2272_D0=   PT2272_TMP^0;
  45          sbit PT2272_D1=   PT2272_TMP^1;
  46          sbit PT2272_D2=   PT2272_TMP^2;
  47          sbit PT2272_D3=   PT2272_TMP^3;
  48          sbit PT2272_VT=   PT2272_TMP^4;
  49          //-----------------------------------
  50          //Î»±äÁ¿
  51          
  52          
  53          
  54          
  55          // ÖÐ¶Ï¡¡IO Ä£Äâ½Å
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 2   

  56          bit io_p00_bit;
  57          bit io_p01_bit;
  58          bit io_p02_bit;
  59          bit io_p03_bit;
  60          bit io_p04_bit;
  61          bit io_p05_bit;
  62          bit io_p06_bit;
  63          bit io_p07_bit;
  64          //¡¡£É£ÏÉèÖÃ¿ªÆôÓë¹Ø±Õ
  65          bit io_p00_on;
  66          bit io_p01_on;
  67          bit io_p02_on;
  68          bit io_p03_on;
  69          bit io_p04_on;
  70          bit io_p05_on;
  71          bit io_p06_on;
  72          bit io_p07_on;
  73          //1MS
  74          /*void Wait_ms
  75          {
  76             unsigned int i;
  77                  while (count)
  78                  {
  79                          i = 115;
  80                          while (i>0) i--;
  81                          count--;
  82              }
  83          
  84          }   */
  85            /*
  86          *********************************************************************************************************
  87          ** º¯ÊýÃû³Æ dmsec()
  88          ** º¯Êý¹¦ÄÜ £ºÑÓÊ± NS
  89          ** Èë¿Ú²ÎÊý £º
  90          ** ³ö¿Ú²ÎÊý :
  91          *********************************************************************************************************
  92          */
  93          //---ÑÓÊ±S------------------------------
  94          void dmsec (unsigned int count)
  95          {
  96   1              unsigned int i;
  97   1              while (count)
  98   1              {
  99   2      
 100   2                      #if   CPU_TYPE2==W78E58
                         i =115;
                      #elif  CPU_TYPE2==STC89E58
 103   2                 i =300;
 104   2              #endif
 105   2      
 106   2      
 107   2      
 108   2                      while (i>0) i--;
 109   2                      count--;
 110   2          }
 111   1      }
 112          
 113          #if   CPU_TYPE2==STC89E58
 114          //--------------------------
 115          /*
 116          *********************************************************************************************************
 117          ** º¯ÊýÃû³Æ     send_UART_two()
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 3   

 118          ** º¯Êý¹¦ÄÜ             ´®¿Ú2·¢ËÍ×Ö·û
 119          ** È«¾Ö±äÁ¿»òÊý×é:
 120          
 121          ** Èë¿Ú²ÎÊý      £º
 122          ** ³ö¿Ú²ÎÊý     £º
 123          *********************************************************************************************************
 124          */
 125          void send_UART_two(char* ptr1_at)
 126          {
 127   1      //sfr  SCON    = 0x98;
 128   1      //SM0,SM1,SM2,REN,TB8,RB8,TI,RI
 129   1      
 130   1      //sfr  S2CON    = 0x9A;
 131   1      //S2SM0,S2SM1,S2SM2,S2REN,S2TB8,S2RB8,S2TI,S2RI
 132   1      //sfr  S2BUF    = 0x9B;
 133   1      //sfr  IE2    = 0xAF;
 134   1      //X,X,X,X,X,X,ESPI,ES2
 135   1      
 136   1              unsigned char temp = 0,j=0;
 137   1      
 138   1      //    ES     =   0;  //¹Ø´®¿Ú1ÖÐ¶Ï
 139   1              IE2     =       0x00;   //¹Ø´®¿Ú2ÖÐ¶Ï,es2=0
 140   1       do{
 141   2      //    TI     =   0;  //ÇåÁã´®¿Ú1·¢ËÍÍê³ÉÖÐ¶ÏÇëÇó±êÖ¾
 142   2         if(ptr1_at[j]==0) break;
 143   2          S2CON       =       S2CON & 0xFD; //B'11111101,ÇåÁã´®¿Ú2·¢ËÍÍê³ÉÖÐ¶ÏÇëÇó±êÖ¾
 144   2      //    SBUF   =   i;
 145   2          S2BUF   =   ptr1_at[j];
 146   2      //    while(TI ==0); //µÈ´ý·¢ËÍÍê³É
 147   2          do
 148   2              {
 149   3                      temp = S2CON;
 150   3                      temp = temp & 0x02;
 151   3              }while(temp==0);
 152   2      
 153   2        }while(ptr1_at[j++]!=0);
 154   1      //      TI     =   0;  //ÇåÁã´®¿Ú·¢ËÍÍê³ÉÖÐ¶ÏÇëÇó±êÖ¾
 155   1          S2CON       =       S2CON & 0xFD; //B'11111101,ÇåÁã´®¿Ú2·¢ËÍÍê³ÉÖÐ¶ÏÇëÇó±êÖ¾
 156   1      //    ES     =   1;  //ÔÊÐí´®¿Ú1ÖÐ¶Ï
 157   1      //      ES2     =       1
 158   1              IE2     =       0x01;   //ÔÊÐí´®¿Ú2ÖÐ¶Ï,ES2=1
 159   1      }
 160          
 161          
 162          /*
 163          *********************************************************************************************************
 164          ** º¯ÊýÃû³Æ     send_com_two()
 165          ** º¯Êý¹¦ÄÜ             ´®¿Ú2·¢ËÍ×Ö·û
 166          ** È«¾Ö±äÁ¿»òÊý×é:
 167          
 168          ** Èë¿Ú²ÎÊý      £º
 169          ** ³ö¿Ú²ÎÊý     £º
 170          *********************************************************************************************************
 171          */
 172          void send_com_two(char* ptr1_at,uchar id)
 173          {
 174   1      //sfr  SCON    = 0x98;
 175   1      //SM0,SM1,SM2,REN,TB8,RB8,TI,RI
 176   1      
 177   1      //sfr  S2CON    = 0x9A;
 178   1      //S2SM0,S2SM1,S2SM2,S2REN,S2TB8,S2RB8,S2TI,S2RI
 179   1      //sfr  S2BUF    = 0x9B;
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 4   

 180   1      //sfr  IE2    = 0xAF;
 181   1      //X,X,X,X,X,X,ESPI,ES2
 182   1      
 183   1              unsigned char temp = 0,j=0;
 184   1      
 185   1      //    ES     =   0;  //¹Ø´®¿Ú1ÖÐ¶Ï
 186   1              IE2     =       0x00;   //¹Ø´®¿Ú2ÖÐ¶Ï,es2=0
 187   1       do{
 188   2      //    TI     =   0;  //ÇåÁã´®¿Ú1·¢ËÍÍê³ÉÖÐ¶ÏÇëÇó±êÖ¾
 189   2         if(j==id) break;
 190   2          S2CON       =       S2CON & 0xFD; //B'11111101,ÇåÁã´®¿Ú2·¢ËÍÍê³ÉÖÐ¶ÏÇëÇó±êÖ¾
 191   2      //    SBUF   =   i;
 192   2          S2BUF   =   ptr1_at[j];
 193   2      //    while(TI ==0); //µÈ´ý·¢ËÍÍê³É
 194   2          do
 195   2              {
 196   3                      temp = S2CON;
 197   3                      temp = temp & 0x02;
 198   3              }while(temp==0);
 199   2      
 200   2        }while(j++!=id);
 201   1      //      TI     =   0;  //ÇåÁã´®¿Ú·¢ËÍÍê³ÉÖÐ¶ÏÇëÇó±êÖ¾
 202   1          S2CON       =       S2CON & 0xFD; //B'11111101,ÇåÁã´®¿Ú2·¢ËÍÍê³ÉÖÐ¶ÏÇëÇó±êÖ¾
 203   1      //    ES     =   1;  //ÔÊÐí´®¿Ú1ÖÐ¶Ï
 204   1      //      ES2     =       1
 205   1              IE2     =       0x01;   //ÔÊÐí´®¿Ú2ÖÐ¶Ï,ES2=1
 206   1      }
 207          
 208           /*
 209          *********************************************************************************************************
 210          ** º¯ÊýÃû³Æ serial_port_two_initial()
 211          ** º¯Êý¹¦ÄÜ £º STC12C5A32S2 Ë«´®¿Ú¹¦ÄÜ
 212          ** Èë¿Ú²ÎÊý £º
 213          **             È«¾Ö ±ä×î
 214          ** ³ö¿Ú²ÎÊý :
 215          *********************************************************************************************************
 216          */
 217          void serial_port_two_initial()
 218          {
 219   1      /*
 220   1      12T  reload=256-INT(fosd/reload/32/12+0.5)
 221   1      1T   reload=256-INT(fosd/reload/32+0.5)
 222   1      //      reload ²úÉúµÄ²¨ÌØÂÊ
 223   1      
 224   1      //baud=fosd/(256-reload)/32/12      12T
 225   1      //baud=fosd/(256-reload)/32          1T
 226   1      //  fosd=22.1184MHZ , baud=57600 (12T)
 227   1          reload=256-INT(22118400/57600/32/12+0.5)
 228   1              =256-INT(1.5)
 229   1              =256-1
 230   1              =255
 231   1         baud= 22118400/(256-255)/32/12
 232   1             =57600
 233   1             ±¾»ú²ÉÓÃ11.22118400  ,²¨ÌØÂÊ 38400
 234   1            reload=256-INT(11059200/38400/32+0.5)
 235   1                  =256- 9
 236   1                  =247
 237   1      
 238   1       */
 239   1      
 240   1      //sfr  SCON    = 0x98;
 241   1      //SM0,SM1,SM2,REN,TB8,RB8,TI,RI
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 5   

 242   1      
 243   1      //sfr  S2CON    = 0x9A;
 244   1      //S2SM0,S2SM1,S2SM2,S2REN,S2TB8,S2RB8,S2TI,S2RI
 245   1      //sfr  S2BUF    = 0x9B;
 246   1      //sfr  IE2    = 0xAF;
 247   1      //X,X,X,X,X,X,ESPI,ES2
 248   1      
 249   1              S2CON    =   0x50;   //0101,0000 8Î»¿É±ä²¨ÌØÂÊ£¬ÎÞÆæÅ¼Ð£ÑéÎ»,ÔÊÐí½ÓÊÕ
 250   1              BRT     =       247;
 251   1      //AUXR BRTR = 1 ³äÐí¶ÀÁ¢²¨ÌØÂÊ·¢ÉúÆ÷¹¤×÷
 252   1      //     S1BRS = 1   ¶ÀÁ¢²¨ÌØÂÊ·¢ÉúÆ÷×÷Îª´®¿Ú²¨ÌØÂÊ·¢ÉúÆ÷,T1¿ÉÓÃ
 253   1      //     EXTRAM = 0  ¿ªÆôÍâ²¿RAM
 254   1      //   BRTR = 1  S1BRS = 1, EXTRAM = 0 ENABLE EXTRAM
 255   1              //AUXR  =       0x11; // T0x12,T1x12,UART_M0x6,BRTR,S2SMOD,BRTx12,EXTRAM,S1BRS
 256   1            AUXR      =       0x14;
 257   1      //    ES      =   1;    //ÔÊÐí´®¿Ú1ÖÐ¶Ï
 258   1      //      ES2     =       1
 259   1              IE2     =       0x01;   //ÔÊÐí´®¿Ú2ÖÐ¶Ï,ES2=1
 260   1        //  EA      =   1;    //¿ª×ÜÖÐ¶Ï
 261   1      }
 262          
 263          
 264          void Interrupt_Receive_2(void) interrupt 8
 265          {
 266   1      //sfr  SCON    = 0x98;
 267   1      //SM0,SM1,SM2,REN,TB8,RB8,TI,RI
 268   1      
 269   1      //sfr  S2CON    = 0x9A;
 270   1      //S2SM0,S2SM1,S2SM2,S2REN,S2TB8,S2RB8,S2TI,S2RI
 271   1      //sfr  S2BUF    = 0x9B;
 272   1      //sfr  IE2    = 0xAF;
 273   1      //X,X,X,X,X,X,ESPI,ES2
 274   1      
 275   1              unsigned char   k   =   0;
 276   1              k = S2CON ;
 277   1              k       = k & 0x01;
 278   1              //if(S2RI==1)
 279   1          if(k==1)
 280   1          {
 281   2              //RI  =   0;
 282   2                      S2CON = S2CON & 0xFE; //1111,1110
 283   2             // k   =   S2BUF;
 284   2             if((pc_count<MAX_TM-1))//Ã»ÓÐ·¢ËÍÊ±²ÅÄÜ½øÐÐ½ÓÊÕ
 285   2                      {   pc_buff[pc_count++]=S2BUF;
 286   3                              pc_buff[pc_count]=0;
 287   3                              pc_bit=1;    //½ÓÊÕµ½Êý¾Ý,½øÈëÖÐ¶ÏÇëÇó
 288   3      
 289   3                      }
 290   2             else
 291   2              {
 292   3                 return;
 293   3              }
 294   2      
 295   2          }
 296   1          else
 297   1          {
 298   2              //TI  =  0;
 299   2                      S2CON = S2CON & 0xFD; //1111,1101
 300   2          }
 301   1      }
 302          
 303          #endif
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 6   

 304          
 305          //------------------------------------------
 306          
 307           //Ó²¼þ´¦Àí
 308            /*
 309          *********************************************************************************************************
 310          ** º¯ÊýÃû³Æ int_p02()
 311          ** º¯Êý¹¦ÄÜ £º °´¼ü ´¦Àí
 312          ** Èë¿Ú²ÎÊý £ºptr --at_buf ATÖ¸Áî·¢ËÍÓÃ ptr1_code  ¶ÌÐÅÄÚÈÝ,ptr2,TEL_temp µç»°ºÅÂë,
 313          **            ID -ÔÝÊ±²ÎÊý   ,È«¾Ö ±ä×î read_tmp  ptr1_at, uart_buff,0,TEL_temp receive_count
 314          ** ³ö¿Ú²ÎÊý :
 315          *********************************************************************************************************
 316          */      //char* ptr1_at,char* ptr1_code, char* ptr_tel
 317          void int_p02(char* ptr1_at,char* ptr1_code, char* ptr_tel) // ·¢¶ÌÖÐÎÄ¶ÌÐÅÇ°ÉèÖÃ¡£ P0.2µÆÉÁ£¬Í¬Ê±·äÃùÆ÷³¤½
             -ÐÒ»Éù
 318          {    uchar tmp_i;
 319   1      
 320   1           BELL=0;
 321   1           for(tmp_i=0;tmp_i<8;tmp_i++)
 322   1           {  dmsec(100);
 323   2           }
 324   1              BELL=1; //·äÃùÆ÷
 325   1      
 326   1           io_p00_on=1; //ÇåÖÐ¶Ï
 327   1      
 328   1      
 329   1            //¶Áµç»°±¾£±
 330   1            read_tmp=1  ;
 331   1                tmp_i=PHONE_RD(ptr1_at,ptr1_code,read_tmp);
 332   1                ptr1_code[tmp_i++]=0;
 333   1                ptr1_code[tmp_i++]=0;
 334   1      
 335   1                tmp_i=0;   // ½«¶Á³öµÄµç»°ºÅÂë×ª´æÆðÀ´£¬×ö·¢ËÍ¶Ô·½ºÅÂë
 336   1                do{
 337   2                     ptr_tel[tmp_i]=ptr1_code[tmp_i];
 338   2                  }while( tmp_i++<=20);
 339   1      
 340   1             //»ØÖÐÎÄ¶ÌÐÅ
 341   1            send_sms(ptr1_at,ptr1_code,ptr_tel,smss_pud_2); //µ÷ÓÃ·¢¶ÌÐÅ
 342   1      
 343   1      }
 344          
 345          //Ó²¼þ´¦Àí
 346           /*
 347          *********************************************************************************************************
 348          ** º¯ÊýÃû³Æ int_p03()
 349          ** º¯Êý¹¦ÄÜ £º °´¼ü ´¦Àí
 350          ** Èë¿Ú²ÎÊý £ºptr --at_buf ATÖ¸Áî·¢ËÍÓÃ ptr1_code  ¶ÌÐÅÄÚÈÝ,ptr2,TEL_temp µç»°ºÅÂë,
 351          **            ID -ÔÝÊ±²ÎÊý   ,È«¾Ö ±ä×î read_tmp  ptr1_at, uart_buff,0,TEL_temp receive_count
 352          ** ³ö¿Ú²ÎÊý :
 353          *********************************************************************************************************
 354          */
 355          //·¢¶ÌÖÐÎÄ¶ÌÐÅÇ°ÉèÖÃ¡£ P0.2µÆÉÁ£¬Í¬Ê±·äÃùÆ÷³¤½ÐÒ»Éù
 356          void int_p03 (char* ptr1_at,char* ptr1_code, char* ptr_tel ) //
 357          {      uchar i;
 358   1           BELL=0;
 359   1           for(i=0;i<8;i++)
 360   1           {  dmsec(100);
 361   2           }
 362   1           BELL=1;  //·äÃùÆ÷
 363   1            io_p02_on=1;
 364   1      
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 7   

 365   1           //----------------------------
 366   1            //¶Áµç»°±¾£± para_temp[0]='1'
 367   1             read_tmp=1;
 368   1                i=PHONE_RD(ptr1_at,ptr1_code,read_tmp);
 369   1                ptr1_code[i++]=0;
 370   1      
 371   1               //----------------------
 372   1               //__________________________________
 373   1                i=0;   // ½«¶Á³öµÄµç»°ºÅÂë×ª´æÆðÀ´£¬×ö·¢ËÍ¶Ô·½ºÅÂë
 374   1                do{
 375   2                     ptr_tel[i]=ptr1_code[i];
 376   2                  }while( i++<=20);
 377   1                //------------------------------------
 378   1             //Ó¢ÎÄ¶ÌÐÅ»Ø
 379   1            send_sms(ptr1_at,ptr1_code,ptr_tel,smss_text_1);       //  //µ÷ÓÃ·¢¶ÌÐÅ
 380   1      
 381   1      
 382   1      }
 383          
 384          //------------------------
 385          //----------------------
 386          /*
 387          *********************************************************************************************************
 388          ** º¯ÊýÃû³Æ     Int_Timer0()
 389          ** º¯Êý¹¦ÄÜ             ¶¨Ê±Æ÷ÖÐ¶ÏÎ»,ÊÇÕû¸ö³ÌÐòµÄÐÄÌø,Èç¹ûÍ£Ö¹,³ÌÐò»áËÀ»ú
 390          ** È«¾Ö±äÁ¿»òÊý×é:
 391          
 392          ** Èë¿Ú²ÎÊý      £º
 393          ** ³ö¿Ú²ÎÊý     £º
 394          *********************************************************************************************************
 395          */
 396          
 397          void  Int_Timer0(void) interrupt 1 using 3
 398          {
 399   1           TH0 = 0xB8;
 400   1               TL0 = 0x00; //20msµÄÊ±ÖÓ»ù×¼
 401   1      
 402   1         timer_1S_cnt++;   timercount++;
 403   1         if(timer_1S_cnt==50)    //20¡Á50=1000MS  =1S
 404   1          { timer_10S_cnt++; timer_1S_cnt=0;
 405   2            timer_S_cnt++;
 406   2                LED_S0=~LED_S0;
 407   2      
 408   2          }                              //£±Ãë£½£±£°£°£°ºÁÃë
 409   1          if(timer_10S_cnt==10)   //10S
 410   1          {
 411   2                 timer_10S_cnt=0;
 412   2      
 413   2              }
 414   1      
 415   1        //---------Ó²¼þÖÐ¶Ï´¦Àí---------------------------------------------------------------------
 416   1         //-------P2.7-D0,P2.6-D1,P2.5-D2,P2.4-D3,    P2.3-VT-315MÓÐÐÅºÅÖÐ¶Ï£¬----------------------------
 417   1         //Èç¹ûÓÐPT2272½ÓÈë P2½ÓÈë¿Ú»áÎªµÍ£¬P2.3-P2.7=0;
 418   1          P2=0xff;
 419   1          PT2272_BUF= P2&0x0F;     //¼ÓVT¾ÍÊÇ0xf1
 420   1          if(PT2272_BUF==0)  //×´Ì¬¼ì²â
 421   1          {    PT2272_BIT=1; //¿ÉÒÔ½øÐÐÖÐ¶Ï
 422   2          }
 423   1      
 424   1          else if(((PT2272_BUF>0)&&((PT2272_BUF&0x0f)!=0x0f))&&PT2272_BIT==1) //ÕâÖÖ·½·¨Ö»ÓÃÓÚPT2272-M4µÄÐ¾Æ¬
 425   1          {   PT2272_TMP= PT2272_BUF;
 426   2              PT2272_BIT=0;
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 8   

 427   2          }
 428   1      
 429   1          //---------------------------
 430   1      
 431   1          IO_P25=1;        //Íâ²¿ÖÐ¶Ï¡¡£Ð£²5¿Ú
 432   1              if((io_p00_bit!=IO_P25))
 433   1              {
 434   2                      if(IO_P25==0)
 435   2                      { io_p00_on=0;
 436   3                      }
 437   2      
 438   2                      io_p00_bit=IO_P25;
 439   2              }
 440   1      
 441   1          IO_P24=1;        //Íâ²¿ÖÐ¶Ï¡¡£Ð24¿Ú
 442   1              if((io_p02_bit!=IO_P24))
 443   1              {
 444   2                      if(IO_P24==0)
 445   2                      { io_p02_on=0;
 446   3                      }
 447   2      
 448   2                      io_p02_bit=IO_P24;
 449   2              }
 450   1      
 451   1              IO_P35=1;        //Íâ²¿ÖÐ¶Ï¡¡£Ð35¿Ú
 452   1              if((io_p03_bit!=IO_P35))
 453   1              {
 454   2                      if(IO_P35==0)
 455   2                      { io_p03_on=0;
 456   3                      }
 457   2      
 458   2                      io_p03_bit=IO_P35;
 459   2              }
 460   1      
 461   1      
 462   1      
 463   1      
 464   1       //------------------------------------------------------------
 465   1      
 466   1      
 467   1      
 468   1      
 469   1      }
 470          
 471          /*
 472          *********************************************************************************************************
 473          ** º¯ÊýÃû³Æ     Int_Uart()
 474          ** º¯Êý¹¦ÄÜ              TC35 µÄÃüÁîÁÐ±í,ÓëÖÐ¶Ï·þÎñ³ÌÐò
 475          ** È«¾Ö±äÁ¿»òÊý×é:   receive_count ½ÓÊÕÖ¸Õë      uart_buff
 476                                ring_bit  ring_cnt
 477          ** Èë¿Ú²ÎÊý      £º
 478          ** ³ö¿Ú²ÎÊý     £º 1-³É¹¦      0-Ê§°Ü
 479          *********************************************************************************************************
 480          */
 481          
 482          void  Int_Uart(void) interrupt 4 using 3  //´®¿ÚµÄÖÐ¶Ï³ÌÐò
 483          {
 484   1      
 485   1              if(RI) //ÃüÁî·½Ê½
 486   1          {
 487   2                      RI=0;
 488   2                if(GPS_ON==1)
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 9   

 489   2                {
 490   3                      if((receive_count<MAX_TM-1))//Ã»ÓÐ·¢ËÍÊ±²ÅÄÜ½øÐÐ½ÓÊÕ
 491   3                      {       //ËùÓÐµÄÃüÁî·µ»Ø¶¼ÊÇ´¦ÓÚ 0x0A [Result] 0x0D Ö®¼ä,ÆäËûÃüÁî,²»»á³öÏÖÕâÖÖÇé¿ö
 492   4                      uart_buff[receive_count++]=SBUF;
 493   4                      uart_buff[receive_count]=0;
 494   4                     //0D 0A 32 0D 0A
 495   4                      if((receive_count==5)&&(uart_buff[0]==0x0d&&uart_buff[1]==0x0A))
 496   4                      {
 497   5                         if(uart_buff[2]=='2')    //µç»°ºôÈë
 498   5                                 {    ring_bit=1;  ring_cnt++;
 499   6                                     receive_count=0;
 500   6                                 }
 501   5                      }
 502   4                      else   if((receive_count>=5&&receive_count<=10)&&(uart_buff[receive_count-2]==0x0d&&uart_b
             -uff[receive_count-1]==0x0A))
 503   4                      {
 504   5                         if(uart_buff[receive_count-3]=='2')    //µç»°ºôÈë
 505   5                                 {    ring_bit=1;  ring_cnt++;
 506   6                                     receive_count=0;
 507   6                                 }
 508   5                      }
 509   4                      }
 510   3                       else
 511   3                       {
 512   4                               return;
 513   4                       }
 514   3               }
 515   2            //--------GPS×¨ÓÃ-------------------------------
 516   2             else
 517   2             {
 518   3                  if((receive_count<MAX_TM-3))//Ã»ÓÐ·¢ËÍÊ±²ÅÄÜ½øÐÐ½ÓÊÕ
 519   3                      {       //ËùÓÐµÄÃüÁî·µ»Ø¶¼ÊÇ´¦ÓÚ 0x0A [Result] 0x0D Ö®¼ä,ÆäËûÃüÁî,²»»á³öÏÖÕâÖÖÇé¿ö
 520   4                      uart_buff[receive_count++]=SBUF;
 521   4                      }
 522   3                       else
 523   3                       {  // receive_count=0;
 524   4                               return;
 525   4                       }
 526   3                  if((uart_buff[receive_count-2]==0x0d)
 527   3                                 &&(uart_buff[receive_count-1]==0x0a) )
 528   3                          {
 529   4                                 return;
 530   4      
 531   4                          }
 532   3      
 533   3             }
 534   2            //------------------------------------
 535   2      
 536   2              }//End of if(RI)
 537   1      }
 538          
 539          /*********************************************************************
 540           *                  C51ÖÐ×Ö·û´®º¯ÊýµÄÀ©³ä                            *
 541           ** º¯ÊýÃû³Æ    : strsearch ()
 542           ** º¯Êý¹¦ÄÜ    : ÔÚÖ¸¶¨µÄÊý×éÀïÁ¬ÐøÕÒµ½ÏàÍ¬µÄÄÚÈÝ
 543           ** Èë¿Ú²ÎÊý   £º ptr2=ÒªÕÒµÄÄÚÈÝ, ptr1 µ±Ç°Êý×é
 544           **** ³ö¿Ú²ÎÊý £º 0-Ã»ÓÐ ÕÒµ½   >1 ²éÕÒµ½
 545           *********************************************************************/
 546          
 547          
 548          uchar strsearch(uchar *ptr2,uchar *ptr1_at)//²é×Ö·û´®*ptr2ÔÚ*ptr1ÖÐµÄÎ»ÖÃ
 549          //±¾º¯ÊýÊÇÓÃÀ´¼ì²é×Ö·û´®*ptr2ÊÇ·ñÍêÈ«°üº¬ÔÚ*ptr1ÖÐ
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 10  

 550          //·µ»Ø:  0  Ã»ÓÐÕÒµ½
 551          //       1-255 ´ÓµÚN¸ö×Ö·û¿ªÊ¼ÏàÍ¬
 552          {
 553   1      //¡¢    uchar max_length;
 554   1              uchar i,j,k;
 555   1              uchar flag;
 556   1              if(ptr2[0]==0) return(0);
 557   1              flag=0;
 558   1              for(i=0,j=0;i<MAX_TM-2;i++)
 559   1              {
 560   2              if(ptr1_at[i]==ptr2[j])
 561   2              {//µÚÒ»¸ö×Ö·ûÏàÍ¬
 562   3                      for(k=i;k<MAX_TM-2;k++,j++)
 563   3                      {
 564   4                              if(ptr2[j]==0)//±È½ÏÕýÈ·
 565   4                                      return(i+1);               //·µ»ØÖµÊÇÕûÊý£¬²»º¬0
 566   4                              if(ptr1_at[k]!=ptr2[j]) break;
 567   4                      }
 568   3                      j=0;
 569   3              }
 570   2              }
 571   1              return(0);
 572   1      }
 573          
 574          /*********************************************************************
 575           *                  C51ÖÐ×Ö·û´®º¯ÊýµÄÀ©³ä                            *
 576           ** º¯ÊýÃû³Æ    : strsearch1()
 577           ** º¯Êý¹¦ÄÜ    : ÔÚÖ¸¶¨µÄÊý×éÀïÁ¬ÐøÕÒµ½ÏàÍ¬µÄÄÚÈÝ
 578           ** Èë¿Ú²ÎÊý   £º ptr2=ÒªÕÒµÄÄÚÈÝ, ptr1 µ±Ç°Êý×é, id Êý×é¿ªÊ¼µÄµÚÒ»¸öÎ»ÖÃ
 579           **** ³ö¿Ú²ÎÊý £º 0-Ã»ÓÐ ÕÒµ½   >1 ²éÕÒµ½
 580           *********************************************************************/
 581          //------ÔÚÖ¸¶¨ÒÆÌ¬µÄÊý×éÀïÁ¬ÐøÕÒµ½ÏàÍ¬µÄÄÚÈÝ---------------------------------------
 582          //i=´«À´µÄÖ¸Áî,  *ptr2=ÒªÕÒµÄÄÚÈÝ, uchar *ptr1 µ±Ç°Êý×é
 583          uchar strsearch1(uchar i,uchar *ptr2,uchar *ptr1)
 584          {      uchar j=0,k;
 585   1                              k=i;
 586   1            do{
 587   2                              if(ptr2[j]==0)  return(k);
 588   2                      if(ptr1[k]==ptr2[j])
 589   2                      {j++;k++;}
 590   2                      else return(0);
 591   2      
 592   2              }while(j<=60);
 593   1              return(0xff);
 594   1      }
 595          
 596          /*
 597          *********************************************************************************************************
 598          ** º¯ÊýÃû³Æ      Read_Call_ID()
 599          ** º¯Êý¹¦ÄÜ              //   ¶ÁÀ´µçºÅÂë
 600          ** È«¾Ö±äÁ¿»òÊý×é:   receive_count ½ÓÊÕÖ¸Õë
 601          ** Èë¿Ú²ÎÊý      £º  ATÖ¸Áî ×Ö·û´®str_code -para_temp   str_at- uart_buff
 602                                  *str_at=Òª¸´ÖÆµÄÄÚÈÝ/×ªATÖ¸Áî
 603                                  *ptr_tel   µç»°ºÅÂë
 604          
 605          ** ³ö¿Ú²ÎÊý     £º 1-³É¹¦      0-Ê§°Ü
 606          *********************************************************************************************************
 607          */
 608          uchar Read_Call_ID(char* ptr1_at,char* ptr1_tel)//¶Á³öÀ´µçÏÔÊ¾µÄºÅÂë
 609          //ÕýÈ·  TRUE
 610          //´íÎó  FALSE
 611          //ºÅÂë  string_temp[0..16],×î¶àÏÔÊ¾Ç°16Î»
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 11  

 612          //ºô½Ð·½Ê½ stringt_temp[20]
 613          {
 614   1              uchar idata i,j,r;
 615   1      
 616   1              Send_AT_Command(CALL_ID,ptr1_at,0);//+CLCC:1,1,4,0,0,"02138950224",129
 617   1              //      ÓïÒôºôÈë
 618   1          timercount=0; while(timercount<50);
 619   1                 //¶ÁÀ´µçÏÔÊ¾³ö´íÊ±ÉèÎª1
 620   1              if(receive_count<15) return(FALSE);
 621   1              ptr1_at[receive_count]=0;
 622   1            receive_count=0;
 623   1              j=0;
 624   1      //      i=strsearch(uart_buff,"CLCC");//²éµÚÒ»¸öCLCC
 625   1          i=strsearch("CLCC",ptr1_at);//²éµÚÒ»¸öCLCC
 626   1              if(i==0) return(FALSE);
 627   1              j=j+i;
 628   1              for(r=0;r<9;r++)
 629   1              {
 630   2              if(ptr1_at[j]==',')   break;
 631   2              else  j=j+1;
 632   2         }
 633   1              if(r>=9) return(FALSE);
 634   1              j=j+1;
 635   1              for(r=0;r<4;r++)
 636   1              {
 637   2                      if(ptr1_at[j]==',')    break;
 638   2                      else  j=j+1;
 639   2          }
 640   1              if(r>=4) return(FALSE);
 641   1              j=j+1;
 642   1              //¼ì²éÊÇ·ñÎªÀ´»°ºô½Ð
 643   1              if(ptr1_at[j]!='4') return(FALSE);
 644   1              for(r=0;r<4;r++)
 645   1              {
 646   2              if(ptr1_at[j]==',')    break;
 647   2              else  j=j+1;
 648   2          }
 649   1              if(r>=4) return(FALSE);
 650   1              j=j+1;
 651   1      //      string_temp[20]=uart_buff[j];//¶Á³öºô½ÐÀàÐÍ
 652   1              //Ö»ÒªÄÜ¶Á³öºô½ÐÀàÐÍ¾ÍÈÏÎªÕýÈ·
 653   1         //   i=strsearch("\x22",uart_buff);//²éµÚÒ»¸ö"ºÅ
 654   1              for(r=0;r<6;r++)
 655   1              {
 656   2              if(ptr1_at[j]=='\x22')   break;
 657   2              else  j=j+1;
 658   2          }
 659   1      
 660   1              if(r>=6)
 661   1                      return(FALSE);
 662   1              j=j+1;
 663   1          i=j;
 664   1         //   i=strsearch( "\x22",uart_buff);//²éµÚ¶þ¸ö"ºÅ
 665   1              for(r=0;r<20;r++)
 666   1              {
 667   2              if(ptr1_at[j]=='\x22')   break;
 668   2              else  j=j+1;
 669   2         }
 670   1         if(i<=2) return(FALSE);//Ã»ÓÐÀ´µçºÅÂë
 671   1      
 672   1         //´æºÅÂë  TEL_temp
 673   1         for(r=0;r<22;r++)
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 12  

 674   1              {
 675   2             ptr1_tel[r]=ptr1_at[i++];
 676   2                 if(ptr1_at[i]=='\x22')
 677   2                 {      r++;
 678   3                       ptr1_tel[r]=0;
 679   3                       ptr1_at[i++]=0;
 680   3      
 681   3                       break;
 682   3                 }
 683   2      
 684   2               }
 685   1      
 686   1          if(r>=22)   return(FALSE);//³ö´í
 687   1            ptr1_at[i++]=0;
 688   1           if(r>8) //ºÅÂë´óÓÚ8Î»ËµÃ÷ÊÇ³£ÓÃ ºÅÂë,²»ÊÇ·þÎñºÅÂë
 689   1                  return(TRUE);
 690   1               else   return(FALSE);
 691   1      
 692   1      }
 693          
 694          /*
 695          *********************************************************************************************************
 696          ** º¯ÊýÃû³Æ      ring_auto()
 697          ** º¯Êý¹¦ÄÜ              //   µç»°ºôÈë ´¦Àí
 698          ** È«¾Ö±äÁ¿»òÊý×é:   receive_count ½ÓÊÕÖ¸Õë   ring_bit  ring_cnt
 699          ** Èë¿Ú²ÎÊý      £º  ATÖ¸Áî ×Ö·û´®str_code -para_temp   str_at- uart_buff
 700                                  *str_at=Òª¸´ÖÆµÄÄÚÈÝ/×ªATÖ¸Áî
 701                              str_code ÄÚÈÝ
 702                                  *ptr_tel   µç»°ºÅÂë
 703          
 704          ** ³ö¿Ú²ÎÊý     £º
 705          *********************************************************************************************************
 706          */
 707          // //char* ptr1_at,char* ptr1_code, char* ptr_tel
 708          void ring_auto( char* ptr1_at,char* ptr1_code, char* ptr_tel)
 709          {
 710   1      
 711   1           if(Read_Call_ID(ptr1_at,ptr_tel))    //¶ÁÀ´µçÏÔÊ¾
 712   1              {
 713   2                          IO_OUT=~IO_OUT; //smss_text_tmp
 714   2                          Send_AT_Command(HOOKOFF,ptr1_at,0);
 715   2                           Send_AT_Command(HOOKOFF,ptr1_at,0);
 716   2                           if(IO_OUT==1)  //¶Ï¿ª
 717   2                              strcpy(ptr1_code,"CLOSE\x1a");
 718   2                           else           //ÎüºÏ
 719   2                               strcpy(ptr1_code,"OPEN\x1a");
 720   2                                        //  //µ÷ÓÃ·¢¶ÌÐÅ
 721   2                                       send_sms(ptr1_at,ptr1_code,ptr_tel,smss_text_tmp);
 722   2              }
 723   1              Send_AT_Command(HOOKOFF,ptr1_at,0);
 724   1              Send_AT_Command(HOOKOFF,ptr1_at,0);
 725   1             ring_bit=0; ring_cnt=0;
 726   1            return;
 727   1      }
 728          //----------------------------------------------
 729          /*
 730          *********************************************************************************************************
 731          ** º¯ÊýÃû³Æ      : P2_INIT()
 732          ** º¯Êý¹¦ÄÜ              ÕâÀï½øÐÐÖÐ¶Ï²éÑ¯Èç¹ûÓÐÖÐ¶ÏÂíÉÏ´¦Àí-
 733          ** È«¾Ö±äÁ¿»òÊý×é:   receive_count ½ÓÊÕÖ¸Õë
 734          ** Èë¿Ú²ÎÊý      £º type =ID,  ×ªÏòËùÓÐ  ATÖ¸Áî ×Ö·û´®
 735                                                  str_at- uart_buff   str_code -para_temp
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 13  

 736          **                      *str_at=Òª¸´ÖÆµÄÄÚÈÝ/×ªATÖ¸Áî
 737          **                      *str_code  ÄÚÈÝ»ò²ÎÊý
 738          ** ³ö¿Ú²ÎÊý     £º  1- ³É¹¦,  0- Ê§°Ü
 739          *********************************************************************************************************
 740          */
 741          //---------ÕâÀï½øÐÐÖÐ¶Ï²éÑ¯Èç¹ûÓÐÖÐ¶ÏÂíÉÏ´¦Àí----------------------
 742          uchar P2_INIT()
 743          {     uchar  tmp_j;
 744   1      
 745   1            if(!io_p00_on )
 746   1              { io_p00_on=1;
 747   2                 //system_server=SYS_KEY_2;
 748   2                 return(SYS_KEY_2);
 749   2               }
 750   1            else if(!io_p02_on)
 751   1              {   io_p02_on=1;
 752   2                 // system_server=SYS_KEY_1;
 753   2                  return(SYS_KEY_1);
 754   2              }
 755   1            if(!io_p03_on )
 756   1             {   io_p03_on=1;
 757   2                       BELL=0;
 758   2                       for(tmp_j=0;tmp_j<8;tmp_j++)
 759   2                       {  dmsec(100);}
 760   2                       BELL=1;  //·äÃùÆ÷
 761   2               system_server=SYS_DIAL;
 762   2               return(0);
 763   2             }
 764   1      
 765   1           if(ring_bit)
 766   1           {    ring_bit=0;
 767   2                BELL=0;
 768   2               for(tmp_j=0;tmp_j<8;tmp_j++)   {  dmsec(100);}
 769   2               BELL=1;  //·äÃùÆ÷
 770   2              // system_server=SYS_RING ;
 771   2               return(SYS_RING);
 772   2            }
 773   1      
 774   1      
 775   1           //---------------------------------------------------
 776   1            return(0);
 777   1      }
 778          //----------------------------------------------------------------
 779          /*
 780          *********************************************************************************************************
 781          ** º¯ÊýÃû³Æ      LED_1()
 782          ** º¯Êý¹¦ÄÜ             µÆÉÁÓë ÎÞÏß½Ó¼ü´¦Àí uart_buff
 783          ** Èë¿Ú²ÎÊý
 784          ** ³ö¿Ú²ÎÊý     £º
 785          *********************************************************************************************************
 786          */
 787           //-----µÆÉÁÓë ÎÞÏß½Ó¼ü´¦Àí,--------------------------------------------
 788          void LED_1()
 789          {
 790   1              LED_P0++;
 791   1              if(LED_P0>=7) LED_P0=0;
 792   1         if((PT2272_TMP>0))      //513MÖÐ¶Ïºó´¦Àí¡£ÕâÀïÖ»ÊÇÈÃµÆÁÁ¼¸ÃëÖÓ
 793   1             {  P0=0;
 794   2                if(PT2272_D0==1)  //A¼ü      D1µÆÁÁ
 795   2                { P0_7=1;
 796   3                  timercount=0; while(timercount<215) watch_dog_clear;
 797   3                  P0_7=0;PT2272_D0=0;
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 14  

 798   3                }
 799   2                if(PT2272_D1==1) //B¼ü       D6µÆÁÁ
 800   2                { P0_6=1;
 801   3                  timercount=0; while(timercount<215) watch_dog_clear;
 802   3                  P0_6=0; PT2272_D1=0;
 803   3                }
 804   2                if(PT2272_D2==1) ////C¼ü    D8µÆÁÁ
 805   2                { P0_5=1;
 806   3                  timercount=0; while(timercount<215) watch_dog_clear;
 807   3                  P0_5=0; PT2272_D2=0;
 808   3                }
 809   2                if(PT2272_D3==1)  // //D¼ü  D9µÆÁÁ
 810   2                { P0_4=1;
 811   3                  timercount=0; while(timercount<215) watch_dog_clear;
 812   3                  P0_4=0; PT2272_D3=0;
 813   3                }
 814   2      
 815   2              }
 816   1             else
 817   1             {
 818   2              if(LED_P0<=7)     //Á÷Ë®µÆ
 819   2               {  timercount=0; while(timercount<10)  ;
 820   3                      P0=(0x80>>LED_P0);
 821   3               }
 822   2               else
 823   2               {P0=(0x80>>LED_P0-8);}
 824   2             }
 825   1      
 826   1      
 827   1      
 828   1      
 829   1      }
 830          
 831          /*
 832          *********************************************************************************************************
 833          ** º¯ÊýÃû³Æ      CMGD_GSM()
 834          ** º¯Êý¹¦ÄÜ               É¾³ý¶ÌÐÅ   uart_buff
 835          ** È«¾Ö±äÁ¿»òÊý×é:   uart_buff   sms_num_tmp
 836          ** Èë¿Ú²ÎÊý      £º  ATÖ¸Áî ×Ö·û´®
 837                                  *str_at=Òª¸´ÖÆµÄÄÚÈÝ/×ªATÖ¸Áî
 838                              id    ¶ÌÐÅID  ¹©É¾³ý¶ÌÐÅÊ±ÓÃ
 839          ** ³ö¿Ú²ÎÊý     £º
 840          *********************************************************************************************************
 841          */
 842          //----------------------------------
 843          //É¾³ý¶ÌÐÅ   uart_buff
 844          void CMGD_GSM(char* ptr1_at,uchar id)
 845          {
 846   1               uchar  ptr1[3] ;
 847   1              ptr1[0]=(id/10)+0x30;
 848   1              ptr1[1]=(id%10)+0x30;
 849   1              ptr1[2]=0;
 850   1                Send_AT_Command(SMS_CMGD,ptr1_at,ptr1);    //É¾³ýÆäËüÃ»ÓÐÓÃµÄ¶ÌÐÅ
 851   1                Send_AT_Command(SMS_CMGD,ptr1_at,ptr1);
 852   1      
 853   1      
 854   1      }
 855          
 856          /*
 857          *********************************************************************************************************
 858          ** º¯ÊýÃû³Æ      CPMS_SM()
 859          ** º¯Êý¹¦ÄÜ               ¹¦ÄÜ ¶Á¶ÌÐÅ±¨ÎÄ ,ÓÐ¶ÌÐÅ¾Í¶Á¶ÌÐÅ ,°ÑÓÐ¶ÌÐÅµÄIDÕÒµ½,²¢¶Á³öÄÚÈÝ
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 15  

 860          ** È«¾Ö±äÁ¿»òÊý×é:   receive_count ½ÓÊÕÖ¸Õë  uart_buff  sms_num_tmp
 861          ** Èë¿Ú²ÎÊý      £º  ATÖ¸Áî ×Ö·û´®
 862                                  *str_at=Òª¸´ÖÆµÄÄÚÈÝ/×ªATÖ¸Áî
 863                              sms_num_tmp     ¶ÌÐÅID  ¹©É¾³ý¶ÌÐÅÊ±ÓÃ
 864          
 865          ** ³ö¿Ú²ÎÊý     £º 1-³É¹¦ µÃµ½¶ÌÐÅ´æ´¢×î´óÖµ      0-Ê§°Ü
 866          *********************************************************************************************************
 867          */
 868          
 869          uchar CPMS_SM(char* ptr1_at )
 870          //----------------------
 871          {   uchar i,j,r,num_tmp1;
 872   1            for(i=0;i<=100;i++) ptr1_at[i]=0;
 873   1            Send_AT_Command(AT_CPMS,ptr1_at,0);
 874   1            timercount=0; while(timercount<15);
 875   1            if(i=strsearch("+CPMS:",ptr1_at)) //"SM"  +CPMS: 0,20,0,45,0,45
 876   1                               { i=i+5;
 877   2                                   //+CPMS: 0,20,0,45,0,45
 878   2                                if(strsearch1(i,"\x20\x30,",ptr1_at))  //Ã»ÓÐ¶ÌÐÅ
 879   2                               {     return(0);
 880   3                               }
 881   2                                else  if((ptr1_at[i]==' ')&&((ptr1_at[i+1]>'1')  //9ÒÔÏÂ¶ÌÐÅ´¦Àí
 882   2                                          &&(ptr1_at[i+1]<='9'))&&(ptr1_at[i+2]==','))
 883   2                             {      //+CPMS: 1,20,1,20,1,20
 884   3                                 i=i+1;
 885   3                                         r=ptr1_at[i]-0x30;   //ÓÐ¼¸¸ö¶Ì¸ö
 886   3                                         i++;//,
 887   3                                         i++; //20
 888   3                                         j=0;
 889   3                                         j=ptr1_at[i]-0x30;
 890   3                                         j=j*10; //¸ßÎ»
 891   3                                         i++;
 892   3                                         j=j+(ptr1_at[i]-0x30); //µÍÎ»
 893   3                                         i++;
 894   3                                         if(ptr1_at[i]!=','&&ptr1_at[i+1]==',') //¿ÉÒÔ´æ100ÒÔÉÏµÄ
 895   3                                         { j=j*10;i++;
 896   4                                           j=j+(ptr1_at[i]-0x30);
 897   4      
 898   4                                        }
 899   3                       //·µ»ØÊÇ¿ÉÒÔ´æ¶àÉÙ¶ÌÐÅ
 900   3                                        //r=j+10;
 901   3                               }
 902   2                                else if((ptr1_at[i]==' ')&&((ptr1_at[i+1]>'0')  //10Ìõ¶ÌÐÅÒÔÉÏ´¦Àí
 903   2                                          &&(ptr1_at[i+2]>='0'))&&(ptr1_at[i+3]==','))
 904   2                             {
 905   3                                 i=i+1;
 906   3                                         r=ptr1_at[i++]-0x30;
 907   3                                         r=r*10;   //ÒÆµ½Ê®Î»
 908   3                                         r=r+ptr1_at[i++]-0x30;
 909   3      
 910   3                                         i++; //20
 911   3                                         j=0;
 912   3                                         j=ptr1_at[i]-0x30;
 913   3                                         j=j*10; //¸ßÎ»
 914   3                                         i++;
 915   3                                         j=j+(ptr1_at[i]-0x30); //µÍÎ»
 916   3                                         i++;
 917   3                                         if(ptr1_at[i]!=','&&ptr1_at[i+1]==',') //¿ÉÒÔ´æ100ÒÔÉÏµÄ
 918   3                                         { j=j*10;i++;
 919   4                                           j=j+(ptr1_at[i]-0x30);
 920   4      
 921   4                                        }
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 16  

 922   3                        //·µ»ØÊÇ¿ÉÒÔ´æ¶àÉÙ¶ÌÐÅ
 923   3                                        //r=j+10;
 924   3      
 925   3                                  }
 926   2      
 927   2                              }
 928   1                 else   //³ö´í´¦Àí
 929   1                 {   if(ptr1_at[1]==0x0d&&ptr1_at[0]==0x34)
 930   2                              {
 931   3                                          return(0);
 932   3                          }
 933   2      
 934   2                 }
 935   1      
 936   1               r=j;
 937   1        //---------ÏÂÃæÓÐ¶ÌÐÅÊ±,½øÐÐ¶ÌÐÅ²éÕÒ ´Ó1-100------------------------------------
 938   1               num_tmp1=1;
 939   1              do{
 940   2                  if(r>=100)  //¶ÌÐÅ´æ´¢ºÅ²»ÄÜ³¬¹ý100¸ö
 941   2                      r=1; //
 942   2                  if(r==1)         //Èç¹ûÊÇÒ»Ìõ·¢AT+CMGL=ALL»òAT+CMGL=4
 943   2                      {
 944   3      
 945   3                         Send_AT_Command(SMS_CMGL,ptr1_at,0);
 946   3                                          timercount=0; while(timercount<20);
 947   3                                                  //     +CMGL: 1,1,,35
 948   3                                                  i=strsearch("+CMGL: ",ptr1_at) ;
 949   3      
 950   3                                         if(i)  //²é¶ÌÐÅ´úÂë»Ø¸´ÊÇ·ñ¶Ô
 951   3                                          {
 952   4                                                i=i+6;
 953   4                                            if(ptr1_at[i+1]==',')
 954   4                                                {
 955   5                                                  num_tmp1=ptr1_at[i]-0x30; //µ±Ç°¶ÌÐÅ´æ´¢ºÅ 10ÒÔÄÚ
 956   5                                                }
 957   4                                                else        //µ±Ç°¶ÌÐÅ´æ´¢ºÅ 10ÒÔÉÏ
 958   4                                                {
 959   5                                                    num_tmp1=ptr1_at[i++]-0x30;
 960   5                                                    num_tmp1=num_tmp1*10;
 961   5                                                        num_tmp1=num_tmp1+ptr1_at[i++]-0x30;
 962   5      
 963   5                                                }
 964   4                                            sms_num_tmp=num_tmp1;
 965   4                                            return(1);
 966   4                                          }
 967   3      
 968   3                      }
 969   2                              else
 970   2                                      {
 971   3                                              i= READ_TEL(ptr1_at,num_tmp1) ;
 972   3                                              if(i==1) //ÓÐ¶ÌÐÅÌø³ö
 973   3                                              {    i=i+7;
 974   4                                             sms_num_tmp=num_tmp1;
 975   4                                             return(1);
 976   4                                              }
 977   3                         else if(i==4)
 978   3                         {
 979   4                            return(0);
 980   4                         }
 981   3                                      }
 982   2      
 983   2                              r--;
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 17  

 984   2                              num_tmp1++; //
 985   2             }while(r!=0);
 986   1            //---------------------------------------------
 987   1            receive_count=0;
 988   1             return(0);
 989   1      
 990   1      
 991   1      }
 992          
 993          
 994          /*
 995          *********************************************************************************************************
 996          ** º¯ÊýÃû³Æ      read_sms()
 997          ** º¯Êý¹¦ÄÜ               ½øÐÐSIM¿¨µÄµç»°±¾¶Á
 998          ** È«¾Ö±äÁ¿»òÊý×é:   receive_count ½ÓÊÕÖ¸Õë
 999          ** Èë¿Ú²ÎÊý      £º  ATÖ¸Áî ×Ö·û´®str_code -para_temp   str_at- uart_buff
1000                                  *str_at=Òª¸´ÖÆµÄÄÚÈÝ/×ªATÖ¸Áî
1001                              str_code ¶ÌÐÅÄÚÈÝ
1002                                  *ptr_tel   µç»°ºÅÂë
1003          
1004          ** ³ö¿Ú²ÎÊý     £º 1-³É¹¦      0-Ê§°Ü
1005          *********************************************************************************************************
1006          */
1007          
1008          //====================================================
1009          uchar  read_sms(char* ptr1_at,char* ptr1_code,char* ptr_tel,char* ptr_gps)
1010          {
1011   1      
1012   1               uint  i;
1013   1           uchar idata  j,  PDU_TEXT,y;
1014   1           if(!CPMS_SM(ptr1_at))
1015   1           {     //Ã»ÓÐ ¶ÌÐÅ·µ»Ø
1016   2                      return(0);
1017   2           }
1018   1            /******************************************/
1019   1            //   //¶ÌÐÅÖÐÐÄºÅÂë×ÖÍ·  //Èç¹û²»ÊÇ,ËµÃ÷Ã»ÓÐ¶ÌÐÅ
1020   1            /****************************************************/
1021   1            if((i=strsearch("08916831",ptr1_at)))
1022   1                       {  i=i+17;  j=0;
1023   2                            //´ø+86µÄÖÐ¹úÒÆ¶¯ÓëÁªÍ¨ÊÖ»ú
1024   2                          if((ptr1_at[i]>='0')&&(ptr1_at[i+1]>='0'))
1025   2                              {    i=i+2;  //µ±Ç°Ö¸ÕëÒÆ¶¯Á½Î»
1026   3                                   //_______È¡³ö¶Ô·½ºÅÂë³¤¶È______________
1027   3                                   j=ptr1_at[i++]-0x30;  //È¡¸ßÎ»
1028   3                                   j=j*16;   //³ÆÈë¸ßÎ»
1029   3                                   if(ptr1_at[i]>=0x41)    //´óÓÚ9µÄµÍÎ»´¦Àí
1030   3                                       {
1031   4                                               j=j+(ptr1_at[i++]-0x37);
1032   4                                       }
1033   3                                       else    //9¼°ÒÔÏÂ´¦Àí
1034   3                                         j=j+(ptr1_at[i++]-0x30);
1035   3                                   //___________________________
1036   3                                    //-½ÓÈëÂë-- 9186  ÓëA1 ½ÓÈëÂë×ÖÍ·
1037   3                                        if(ptr1_at[i]=='9') //
1038   3                                        {
1039   4                                              i=i+4;  //Ö¸ÕëÒÆ¶¯4Î»,È¥µô 9186
1040   4                                        }
1041   3                                    else
1042   3                                      i=i+2;  // Ö¸ÕëÒÆ¶¯2Î»,È¥µô A1
1043   3                                        //j=j-1;
1044   3                                       //------------¶Ô·½ºÅÂë²éÕÒ---------------
1045   3                                       //--µç»°ºÅÂë´æÈë TEL_tempÊý×é
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 18  

1046   3                                         y=0;
1047   3                                    do {
1048   4                                         j--;j--;
1049   4                             ptr_tel[y++]=ptr1_at[i+1];
1050   4                             if(ptr1_at[i]=='F') //ÓÐ²¹Âë
1051   4                             {  ptr_tel[y]=0;
1052   5                                i++; i++;
1053   5                                                    break;
1054   5                             }
1055   4                             ptr_tel[y++]=ptr1_at[i];
1056   4                             i=i+2;
1057   4                               if(y>20) break; //³¤¶È²»ÄÜ³¬¹ý20
1058   4                                      }while(j!=0);
1059   3                                              ptr_tel[y]=0;
1060   3                                       //---------------------------------
1061   3                            //i=i+1;
1062   3                            //ÊÇ·ñÊÇÖÐÎÄÄ£Ê½ 0008   2100
1063   3                                              if((ptr1_at[i]>='0')&&(ptr1_at[i+1]>='0')&&(ptr1_at[i+2]>='0')
1064   3                                              &&(ptr1_at[i+3]=='8'))
1065   3                                              {
1066   4                                                i=i+4; //ÒÆ¶¯4Î»,È¥µô±¾0008
1067   4                            i=i+14; //ÒÆ¶¯14Î»,È¥µô±¾ÈÕÆÚ¼°Ê±¼ä
1068   4                                                i=i+2;
1069   4                             //----------ÄÚÈÝ¸´ÖÆ-½«ÄÚÈÝ·Åµ½para_tempÀï------
1070   4                             for(j=0;j<=MAX_T-3;j++)  //²»ÄÜ³¬¹ý×î´óÖµ
1071   4                             {
1072   5                                   ptr1_code[j]=ptr1_at[i++];
1073   5                                                        if(ptr1_at[i]==0x0d)
1074   5                                                        {  ptr1_code[++j]=0; break;
1075   6                                                        }
1076   5                                PDU_TEXT=0;   //PDU
1077   5                                if(i>=MAX_TM)  break;
1078   5                             }
1079   4                            //---------------------
1080   4                                              }
1081   3                                      // Ó¢ÎÄÄ£Ê½
1082   3                                       else
1083   3                                      {    //AT_CMGF1
1084   4                               Send_AT_Command(AT_CMGF1,ptr1_at,0); //×ª³ÉÓ¢ÎÄ¶Á
1085   4                               Send_AT_Command(AT_CMGF1,ptr1_at,0); //×ª³ÉÓ¢ÎÄ¶Á
1086   4                               timercount=0; while(timercount<8)  ;
1087   4                               READ_TEL(ptr1_at,sms_num_tmp );  //ÔÙ´ÎÒÔÓ¢ÎÄ¶Á¸Õ²Å¶ÌÐÅ
1088   4                               //´Ó¶ÌÐÅ´úÂëÖÐÕÒµ½Î¬Ò»´úÂëÓëÄÚÈÝ¼äµÄ×Ö·û
1089   4                               if((i=strsearch("\x22\x0d\x0a",ptr1_at)))
1090   4                                                      {     i=i+2;//Ö¸ÕëÒÆ¶¯Á½Î»,Ö¸ÏòÄÚÈÝµÄµÚÒ»¸ö×Ö·û
1091   5      
1092   5                                                            //----ÄÚÈÝ¸´ÖÆ-½«ÄÚÈÝ·Åµ½para_tempÀï------------
1093   5                                                             for(j=0;j<=MAX_T-3;j++)
1094   5                                                 {
1095   6                                                        ptr1_code[j]=ptr1_at[i++];
1096   6                                                        //´óÐ¡Ð´×ª»»
1097   6                                            toupper(ptr1_code[j]);
1098   6                                                                                      if(ptr1_at[i]==0x0d)
1099   6                                                                              { ptr1_code[++j]=0; break;
1100   7                                                                              }
1101   6                                                  if(i>=MAX_TM)  break;
1102   6                                                 }
1103   5                                       //---------------------
1104   5                                                      }
1105   4                                 else   goto err_dll;
1106   4                                           PDU_TEXT=1;//ÎÄ±¾
1107   4      
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 19  

1108   4                                    }
1109   3                                      //i++;
1110   3      
1111   3                           } //¹Ì¶¨´úÂë¶Ô²»¶Ô
1112   2                   else goto err_dll;
1113   2      
1114   2      
1115   2      
1116   2                      } //08916831
1117   1                      //------------------------
1118   1               else
1119   1                  goto err_dll;
1120   1          //------------------------------------------
1121   1       /***************************************************/
1122   1       /******************************************/
1123   1         //ÖÐÎÄÄÚÈÝ·ÖÎö
1124   1      /*******************************************/
1125   1          if(PDU_TEXT==0)
1126   1          {     i=0;
1127   2                //5438 5408  ÎüºÏ
1128   2              if(strsearch1(i,"54385408",ptr1_code))
1129   2                               {
1130   3      
1131   3                         timercount=0; while(timercount<200) watch_dog_clear;
1132   3                            //ÓÐÐ©±È½ÏÖØÒªµÄ¶«Î÷Äã¿ÉÒÔ´æµ½¿¨¾Í£¬ÖØÐÂ¿ª»úÒ²Ã»ÓÐÎÊÌâ
1133   3                                      IO_OUT=0;
1134   3                                      strcpy(ptr1_code,"SET OK\x1a");
1135   3                                      system_server=SYS_TEXT_1;
1136   3                                      return(1);
1137   3      
1138   3                               }
1139   2              //  ¶Ï¿ª 65AD 5F00   PUDÂë
1140   2             else  if(strsearch1(i,"65AD5F0",ptr1_code))
1141   2                               {
1142   3      
1143   3                         timercount=0; while(timercount<150) watch_dog_clear;
1144   3                                       IO_OUT=1;
1145   3                                       system_server=SYS_PDU_1;  return(1);
1146   3      
1147   3                               }
1148   2                  else goto err_dll;
1149   2      
1150   2      
1151   2      
1152   2          }
1153   1        /***********************************/
1154   1        /***********************************/
1155   1        //   Ó¢ÎÄ¶ÌÐÅÄÚÈÝ´¦Àí
1156   1        /***********************************/
1157   1        //------------------------------------------------------------
1158   1         else   if(PDU_TEXT==1)//Ó¢ÎÄ
1159   1           {    i=0;
1160   2                 if(strsearch1(i,"START",ptr1_code)) // ¼ÌµçÆ÷ÎüºÏ
1161   2                 {
1162   3      
1163   3      
1164   3                         timercount=0; while(timercount<100) watch_dog_clear;
1165   3                            //ÓÐÐ©±È½ÏÖØÒªµÄ¶«Î÷Äã¿ÉÒÔ´æµ½¿¨¾Í£¬ÖØÐÂ¿ª»úÒ²Ã»ÓÐÎÊÌâ
1166   3                                      IO_OUT=0; //¼ÌµçÆ÷ÎüºÏ
1167   3                                  strcpy(ptr1_code,"SET OK\x1a");
1168   3                                      system_server=SYS_TEXT_1; //×ªÏò¶ÌÐÅ»Ø¸´
1169   3                                       return(1);
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 20  

1170   3      
1171   3                      }
1172   2                      else if(strsearch1(i,"END",ptr1_code))   // ·¢ÖÐÎÄ
1173   2                               {
1174   3      
1175   3      
1176   3                         timercount=0; while(timercount<110) watch_dog_clear;
1177   3                                      IO_OUT=1;   // ¼ÌµçÆ÷¶Ï¿ª
1178   3                                      system_server=SYS_PDU_1;//×ªÏò¶ÌÐÅ»Ø¸´
1179   3                                       return(1);
1180   3      
1181   3                      }
1182   2      
1183   2             //_____µç»°±¾´æ´¢ TEL:1,13818120592  TEL:9,13818120592   ´æµÄÄÚÈÝÊÇTEL_tempÀïµÄÄÚÈÝ,Îª¶Ô·½ºÅÂë
1184   2             else if(j=strsearch1(i,"TEL:",ptr1_code))   //TEL:1,13818120592
1185   2                               {               //ÏòÇ°ÒÆ¶¯ËÄÎ»
1186   3                                       i=i+4;
1187   3                                      j=0;
1188   3                                      if((ptr1_code[i]>='1')&&(ptr1_code[i]<='9'))
1189   3      
1190   3                                      ptr1_code[j++]=ptr1_code[i++];
1191   3                                      else  goto err_dll;
1192   3                                      i++;
1193   3                                      ptr1_code[j++]=',';
1194   3                                      ptr1_code[j++]='"';
1195   3                               // for(i=0;i<=20;i++)
1196   3                               do
1197   3                                {     if(ptr1_code[i]==0x0d||ptr1_code[i]==0x00)
1198   4                              {break;}
1199   4                                         else
1200   4                                            ptr1_code[j++]=ptr1_code[i] ;
1201   4                                            i++;
1202   4                                 }  while(ptr1_code[i]!=0x0d);
1203   3                               ptr1_code[j++]='"';ptr1_code[j++]=0;
1204   3      
1205   3                    Send_AT_Command(PHONE_WRITE,ptr1_at,ptr1_code); //´æµç·Å±¾
1206   3      
1207   3                    system_server=SYS_PDU_1;
1208   3                     return(1);
1209   3      
1210   3                         }
1211   2                      //_____________________________________________
1212   2                         else if(i=strsearch1(i,"GPS",ptr1_code))
1213   2                       {
1214   3                                GPS_READ(ptr1_at,ptr1_code,ptr_gps,0);
1215   3                                strcat(ptr1_code,"\x1a");
1216   3      
1217   3                                system_server=SYS_TEXT_1; //×ªÏò¶ÌÐÅ»Ø¸´
1218   3                                return(1);
1219   3                    }
1220   2                      //---------------------------------------------------
1221   2                         else goto err_dll;
1222   2      
1223   2      
1224   2                      }
1225   1      
1226   1              //-------------------------------------------------------------------
1227   1      
1228   1                              else {
1229   2      
1230   2      err_dll:                        //¶ÌÐÅºÅÂëÉ¾³ý AT+CMGD=01
1231   2                                              CMGD_GSM(ptr1_at,  sms_num_tmp );
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 21  

1232   2      
1233   2                                              for(i=1;i<=MAX_TM-3;i++)
1234   2                                      {    ptr1_at[i]=0; }
1235   2      
1236   2                                      Send_AT_Command(AT_CMGF0,ptr1_at,0);  //ÖÐÎÄ·½Ê½ //ATE0V0^SSMSS=1+CNMI=2,1
1237   2                                      //      Send_AT_Command(AT_SSMSS,ptr1_at,0);
1238   2                                              // return;
1239   2      
1240   2                                       }
1241   1      
1242   1      
1243   1      
1244   1                   return(0);
1245   1      
1246   1      
1247   1      
1248   1      
1249   1      
1250   1      }
1251          /*********************************************************************************************************
1252          ** º¯ÊýÃû³Æ £ºpdu_set()
1253          ** º¯Êý¹¦ÄÜ £ºGSMÄ£¿é·¢ËÍ¶ÌÐÅ
1254          ** Èë¿Ú²ÎÊý £ºptr --at_buf ATÖ¸Áî·¢ËÍÓÃ ptr1_code  ¶ÌÐÅÄÚÈÝ,ptr_tel,TEL_temp µç»°ºÅÂë,
1255          **            ID -ÔÝÊ±²ÎÊý  ¿ÉÒÔ×ªÏò·¢¶ÌÐÅ·½Ê½
1256             È«¾Ö ±ä×î     receive_count
1257          ** ³ö¿Ú²ÎÊý :
1258          *********************************************************************************************************
1259          */
1260          uchar pdu_set(char* ptr1_at,char* ptr1_code,char* ptr_tel)
1261          {     uchar idata ptr_tmp[3];
1262   1            uchar idata r,y;
1263   1                uchar idata i=0,j=0;
1264   1      
1265   1           do{          //PDUÄÚÈÝÒ»¶¨ÊÇ4Î»ÎªÒ»¸öÖÐÎÄ ,
1266   2               i++;
1267   2           }while(ptr1_code[i]!=0);
1268   1      //0011000D91683118180295F20008A70A8F66670953719669FF01
1269   1                  r=i;
1270   1                  i=(i/2)+15;//PDU³¤¶È±¨ÎÄ
1271   1                  ptr_tmp[0]=(i/10)+0x30;
1272   1                      ptr_tmp[1]=(i%10)+0x30;
1273   1                      ptr_tmp[2]=0;
1274   1                              //¶ÌÐÅºÅÂë³¤¶È£¬Èç¹ûÃ¿¼ÓÒ»¸öÖÐÎÄ£¬³¤¶È¼Ó£²
1275   1                  Send_AT_Command(SMS_CMGS,ptr1_at,ptr_tmp);
1276   1                  dmsec(50);
1277   1                               y=0;
1278   1                       strcpy(ptr1_at,"0011000D9168");
1279   1                   y=12;
1280   1                               j=0;  //·¢ËÍ¶Ô·½ºÅÂë
1281   1                                       //¶Ô·½ÊÖ»úºÅÂë ½øÐÐ PDU×ª»»
1282   1                                 // ½«TEL_tempÀïµÄ 13818120592×ª»»3118180295F2ºó·Åµ½ para_tempÀï
1283   1                                              do
1284   1                                              {
1285   2                                            ptr1_at[y++]=ptr_tel[j+1];
1286   2                                            ptr1_at[y++]=ptr_tel[j];
1287   2                                            j=j+2;
1288   2                                            if(ptr_tel[j+1]==0x0d||ptr_tel[j+1]==0)
1289   2                                            { ptr1_at[y++]='F';
1290   3                                              ptr1_at[y++]=ptr_tel[j];
1291   3                                              break;
1292   3                                            }
1293   2                                         } while(j<=20);
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 22  

1294   1                                       ptr1_at[y]=0;
1295   1                                       strcat(ptr1_at,"0008A0");//¶ÌÐÅ¸ñÊ½
1296   1                                      //_________¶ÌÐÅ³¤¶È¡¢£µ¸öºº×Ö£¬10¸öÓ¢ÎÄ   _____________
1297   1      
1298   1                              i=(r/2);//PDU³¤¶È±¨ÎÄ
1299   1                              j=(i/16);
1300   1                              if(j>9)
1301   1                                ptr_tmp[0]=j+0x37;
1302   1                              else
1303   1                               ptr_tmp[0]=j+0x30;
1304   1      
1305   1                              j=(i%16);
1306   1                              if(j>9)
1307   1                                ptr_tmp[1]=j+0x37;
1308   1                              else
1309   1                                ptr_tmp[1]=j+0x30;
1310   1                                      ptr_tmp[2]=0;
1311   1                                         strcat(ptr1_at,ptr_tmp);
1312   1                                      // strcat(ptr1_code,"0A");  //
1313   1                                       //---------------------------------------
1314   1                                      //¶ÌÐÅÄÚÈÝ
1315   1                                      //53D1 9001 6210 529F FF01 ·¢ËÍ³É¹¦
1316   1                              //     strcat(ptr1_code,"53D190016210529FFF01\x1a");
1317   1                       strcat(ptr1_at,ptr1_code);
1318   1                       strcat(ptr1_at,"\x1a");
1319   1      
1320   1      
1321   1                      Send_AT_Command(AT_COMMAND,ptr1_at,0);
1322   1                                       return(i);
1323   1      
1324   1      }
1325          /*
1326          //===================================================
1327          // ·¢ËÍ¶ÌÏûÏ¢ÄÚÈÝ·½Ê½
1328          //====================================================
1329          #define         smss_text_1     1
1330          #define         smss_text_tmp   2
1331          #define         smss_pud_1              3
1332          #define         smss_start              4
1333          #define         smss_pud_1              5
1334           */
1335          /*
1336          *********************************************************************************************************
1337          ** º¯ÊýÃû³Æ £ºsend_sms()
1338          ** º¯Êý¹¦ÄÜ £ºGSMÄ£¿é·¢ËÍ¶ÌÐÅ
1339          ** Èë¿Ú²ÎÊý £ºptr --at_buf ATÖ¸Áî·¢ËÍÓÃ ptr1_code  ¶ÌÐÅÄÚÈÝ,ptr_tel,TEL_temp µç»°ºÅÂë,
1340          **            ID -ÔÝÊ±²ÎÊý  ¿ÉÒÔ×ªÏò·¢¶ÌÐÅ·½Ê½
1341             È«¾Ö ±ä×î     receive_count
1342          ** ³ö¿Ú²ÎÊý :
1343          *********************************************************************************************************
1344          */ // //smss_text_1 smss_text_tmp   smss_pud_1 smss_start   smss_pud_1
1345          //uint8 send_sms( char* ptr1_at,char* ptr1_code, char* ptr_tel,uint8 id)
1346          uchar  send_sms(char* ptr1_at,char* ptr1_code,char* ptr_tel,uchar id) //·¢ËÍ¶ÌÐÅ
1347          {       uchar  j=1,i=1;
1348   1      
1349   1             Send_AT_Command(AT_CMGF0,ptr1_at,0); //ATE0V0^SSMSS=1+CNMI=2,1
1350   1                      switch(id)
1351   1                      {
1352   2                          case        smss_text_1:  //  ·¢ËÍÓ¢ÎÄ
1353   2      
1354   2                           Send_AT_Command(AT_CMGF1,ptr1_at,0);
1355   2                            Send_AT_Command(AT_CMGF1,ptr1_at,0);
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 23  

1356   2                              //AT+CMGS=   "13818120592"    >
1357   2                           i=0;
1358   2                           ptr1_code[i++]='"';
1359   2                           j=0;
1360   2                                               do{
1361   3                                                 ptr1_code[i++]=ptr_tel[j++];
1362   3                                 if(ptr_tel[j]==0x0d||ptr_tel[j]==0)
1363   3                                   {
1364   4                                      ptr1_code[i++]='"';
1365   4                                      ptr1_code[i++]=0;
1366   4                                      break;
1367   4                                     }
1368   3      
1369   3                                               }while( i<=19);
1370   2      
1371   2                                              Send_AT_Command(SMS_CMGS,ptr1_at,ptr1_code);
1372   2                                  Send_AT_Command(CMGS_MUB,ptr1_at,"SEND: OK!\x1a");
1373   2                      break;
1374   2      
1375   2                       case   smss_text_tmp:  // ×¨ÓÃ»Ø¸´  TEL_temp
1376   2                              Send_AT_Command(AT_CMGF1,ptr1_at,0);
1377   2                              //AT+CMGS=   "13818120592"    >
1378   2                              strcpy(ptr1_at,"AT+CMGS=\"");    //AT+CMGS= "13818120592"
1379   2                                              strcat(ptr1_at,ptr_tel);
1380   2                                              strcat(ptr1_at,"\"");
1381   2                                              Send_AT_Command(AT_COMMAND,ptr1_at,0);
1382   2                                    Send_AT_Command(CMGS_MUB,ptr1_at,ptr1_code);
1383   2                      break;
1384   2      
1385   2                case smss_pud_2:         //·¢ËÍÖÐÎÄ
1386   2                     //0011000D91683118180295F20008A70A8F66670953719669FF01
1387   2      
1388   2                        //53D1 9001 6210 529F FF01 ·¢ËÍ³É¹¦
1389   2                                   strcpy(ptr1_code,"53D190016210529FFF01");
1390   2                       i=pdu_set(ptr1_at,ptr1_code,ptr_tel);
1391   2                                         //¶ÌÐÅºÅÂë³¤¶È£¬Èç¹ûÃ¿¼ÓÒ»¸öÖÐÎÄ£¬³¤¶È¼Ó£²
1392   2                     /* Send_AT_Command(SMS_CMGS,ptr1_at,"25");
1393   2      
1394   2                      y=0;
1395   2                      strcpy(ptr1_code,"0011000D9168");
1396   2                      y=12;
1397   2                                      j=0;  //·¢ËÍ¶Ô·½ºÅÂë
1398   2                                       //¶Ô·½ÊÖ»úºÅÂë ½øÐÐ PDU×ª»»
1399   2                                 // ½«TEL_tempÀïµÄ 13818120592×ª»»3118180295F2ºó·Åµ½ para_tempÀï
1400   2                                              do
1401   2                                              {
1402   2                                            ptr1_code[y++]=ptr_tel[j+1];
1403   2                                            ptr1_code[y++]=ptr_tel[j];
1404   2                                            j=j+2;
1405   2                                            if(ptr_tel[j+1]==0x0d||ptr_tel[j+1]==0)
1406   2                                            { ptr1_code[y++]='F';
1407   2                                              ptr1_code[y++]=ptr_tel[j];
1408   2                                              break;
1409   2                                            }
1410   2                                         } while(j<=18);
1411   2                                       ptr1_code[y]=0;
1412   2                                       strcat(ptr1_code,"0008A0");//¶ÌÐÅ¸ñÊ½
1413   2                                       strcat(ptr1_code,"0A");  //¶ÌÐÅ³¤¶È¡¢£µ¸öºº×Ö£¬10¸öÓ¢ÎÄ
1414   2                                      //¶ÌÐÅÄÚÈÝ
1415   2                                      //53D1 9001 6210 529F FF01 ·¢ËÍ³É¹¦
1416   2                                   strcat(ptr1_code,"53D190016210529FFF01\x1a");
1417   2      
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 24  

1418   2                      Send_AT_Command(CMGS_MUB,ptr1_at,ptr1_code);
1419   2                                      */
1420   2                break;
1421   2      
1422   2             case smss_pud_1:
1423   2                    //0011000D91683118180295F20008A70A8F66670953719669FF01
1424   2                        //8BBE 7F6E 6210 529F 0021   ÉèÖÃ³É¹¦!
1425   2                                   strcpy(ptr1_code,"8BBE7F6E6210529F0021");
1426   2                       i=pdu_set(ptr1_at,ptr1_code,ptr_tel);
1427   2                     /*
1428   2                                         //¶ÌÐÅºÅÂë³¤¶È£¬Èç¹ûÃ¿¼ÓÒ»¸öÖÐÎÄ£¬³¤¶È¼Ó£²
1429   2                      Send_AT_Command(SMS_CMGS,ptr1_at,"25");
1430   2      
1431   2                      y=0;
1432   2                      strcpy(ptr1_code,"0011000D9168");
1433   2                      y=12;
1434   2                                      j=0;  //·¢ËÍ¶Ô·½ºÅÂë
1435   2                                       //¶Ô·½ÊÖ»úºÅÂë ½øÐÐ PDU×ª»»
1436   2                                 // ½«TEL_tempÀïµÄ 13818120592×ª»»3118180295F2ºó·Åµ½ para_tempÀï
1437   2                                              do
1438   2                                              {
1439   2                                            ptr1_code[y++]=ptr_tel[j+1];
1440   2                                            ptr1_code[y++]=ptr_tel[j];
1441   2                                            j=j+2;
1442   2                                            if(ptr_tel[j+1]==0x0d||ptr_tel[j+1]==0)
1443   2                                            { ptr1_code[y++]='F';
1444   2                                              ptr1_code[y++]=ptr_tel[j];
1445   2                                              break;
1446   2                                            }
1447   2                                         } while(j<=18);
1448   2                                       ptr1_code[y]=0;
1449   2                                       strcat(ptr1_code,"0008A0");//¶ÌÐÅ¸ñÊ½
1450   2                                       strcat(ptr1_code,"0A");  //¶ÌÐÅ³¤¶È¡¢£µ¸öºº×Ö£¬10¸öÓ¢ÎÄ
1451   2                                      //¶ÌÐÅÄÚÈÝ
1452   2                                      //8BBE 7F6E 6210 529F 0021   ÉèÖÃ³É¹¦!
1453   2                                   strcat(ptr1_code,"8BBE7F6E6210529F0021\x1a");
1454   2                      Send_AT_Command(CMGS_MUB,ptr1_at,ptr1_code);
1455   2                             */
1456   2                break;
1457   2      
1458   2      
1459   2                      //======================·¢ËÍÊÕµ½Éè±¸¿ªÆôÖ¸Áî================================================
1460   2      
1461   2                        default:
1462   2      
1463   2                              break;
1464   2      
1465   2          }
1466   1      
1467   1      
1468   1                receive_count=0;
1469   1                timer_S_cnt=0;
1470   1                while(timer_S_cnt<15 )
1471   1                      {   if(strsearch("+CMGS:",ptr1_at))   break;
1472   2                      }
1473   1                for(i=0;i<=MAX_TM-2;i++) {   ptr1_at[i]=0;    }
1474   1              //  num_tmp1Îª¶ÌÐÅºÅ, ´Ó16½øÖÆ×ª³É ÎÄ±¾·½Ê½²ÅÄÜ·¢ËÍ³öÈ¥
1475   1                  //¶ÌÐÅºÅÂëÉ¾³ý AT+CMGD=01
1476   1                       CMGD_GSM(ptr1_at,  sms_num_tmp );
1477   1               Send_AT_Command(AT_CMGF0,ptr1_at,0); //ATE0V0^SSMSS=1+CNMI=2,1
1478   1      
1479   1               return(0);
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 25  

1480   1      
1481   1      }
1482          
1483          /*
1484          *********************************************************************************************************
1485          ** º¯ÊýÃû³Æ      PHONE_RD()
1486          ** º¯Êý¹¦ÄÜ               ½øÐÐSIM¿¨µÄµç»°±¾¶Á
1487          ** È«¾Ö±äÁ¿»òÊý×é:   receive_count ½ÓÊÕÖ¸Õë
1488          ** Èë¿Ú²ÎÊý      £º  ATÖ¸Áî ×Ö·û´®
1489                                                  str_at- uart_buff   str_code -para_temp
1490          **                      *str_at=Òª¸´ÖÆµÄÄÚÈÝ/×ªATÖ¸Áî
1491          **                      *str   µç»°±¾ÄÚÈÝ
1492                               id µç»°±¾ºÅ
1493          ** ³ö¿Ú²ÎÊý     £º 1-³É¹¦      0-Ê§°Ü
1494          *********************************************************************************************************
1495          */
1496          
1497          //uart_buff,para_temp,read_tmp
1498          uchar PHONE_RD(char* ptr1_at,uchar *str,uchar id )      //read_tmp=0x30+i;  Òª¶ÁµÄµç»°ºÅÂë
1499          {       uchar idata j;
1500   1              uchar  idata ptr[3],i=0;;
1501   1              i=0;
1502   1              ptr[i++]=(id/10)+0x30;
1503   1              ptr[i++]=(id%10)+0x30;
1504   1              ptr[i++]=0;
1505   1              Send_AT_Command(PHONE_READ,ptr1_at,ptr);
1506   1              timercount=0; while(timercount<10);
1507   1               i=0;
1508   1              if(j=strsearch("+CPBR:",ptr1_at))    //+CPBW: 1,"13818120592",129,"chia"
1509   1              {       j=j+9;
1510   2                      do
1511   2                      {
1512   3                                      str[i++]= ptr1_at[j++];
1513   3                                      if( ptr1_at[j]=='"')
1514   3                                      { str[i++]=0;
1515   4                                         return(i);
1516   4                                      }
1517   3      
1518   3      
1519   3                      }while(j<=24);
1520   2      
1521   2      
1522   2             }
1523   1             else if(ptr1_at[1]==0x0d&&ptr1_at[0]==0x34)
1524   1                 {           return(FALSE);
1525   2                      }
1526   1              else return(FALSE);
1527   1      }
1528          
1529          /*
1530          *********************************************************************************************************
1531          ** º¯ÊýÃû³Æ      READ_TEL()
1532          ** º¯Êý¹¦ÄÜ                ½øÐÐSIM¿¨ÖÐµÄ1µ½20Ìõ¶ÌÐÅºÅÂëµÄ¶ÁÈ¡
1533          ** È«¾Ö±äÁ¿»òÊý×é:   receive_count ½ÓÊÕÖ¸Õë
1534          ** Èë¿Ú²ÎÊý      £º  ATÖ¸Áî ×Ö·û´®
1535                                                  str_at- uart_buff   str_code -para_temp
1536          **                      *str_at=Òª¸´ÖÆµÄÄÚÈÝ/×ªATÖ¸Áî
1537          **                      *str_code  ¶ÌÐÅÄÚÈÝ
1538                               id ¶ÌÐÅºÅ
1539          ** ³ö¿Ú²ÎÊý     £º 1-³É¹¦      0-Ê§°Ü
1540          *********************************************************************************************************
1541          */
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 26  

1542          //======================================================================
1543          //======================================================================
1544          //======================================================================
1545          uchar   READ_TEL(char* ptr1_at,uchar  id)                //¶Á¶ÌÐÅºÅÂë£±£­£²£°¸ö
1546          {
1547   1      
1548   1                  uchar  idata ptr1[5],t;
1549   1              t=0;
1550   1              ptr1[t++]=(id/10)+0x30;
1551   1              ptr1[t++]=(id%10)+0x30;
1552   1              ptr1[t++]=0;
1553   1               Send_AT_Command(SMS_CMGR,ptr1_at,ptr1);
1554   1            timercount=0; while(timercount<30);
1555   1           //             +CMGR: 1
1556   1          if(t=strsearch("+CMGR:",ptr1_at))
1557   1              // if(receive_count<10)
1558   1               {          return(1);
1559   2                }   //+CMS ERROR
1560   1           else  if(t=strsearch("+CMS ERROR",ptr1_at))
1561   1           {
1562   2                      return(4);
1563   2           }
1564   1            return(0);
1565   1      
1566   1      }
1567          
1568            /*
1569          *********************************************************************************************************
1570          ** º¯ÊýÃû³Æ Initialize_Model()
1571          ** º¯Êý¹¦ÄÜ £º Ä£¿é³õÊ¼»¯
1572          ** Èë¿Ú²ÎÊý £ºptr1_at --uart_buff ATÖ¸Áî·¢ËÍÓÃ ptr1_code -para_temp ²ÎÊýÄÚÈÝ
1573          **             È«¾Ö ±ä×î    ptr1_at, uart_buff, receive_count
1574          ** ³ö¿Ú²ÎÊý :
1575          *********************************************************************************************************
1576          */
1577          
1578          void Initialize_Model(char* ptr1_at,char* ptr1_code)    //³õÊ¼»¯¡¡PIN¼ì²â
1579          {
1580   1              uchar i,j;
1581   1             ptr1_code[0] =  ptr1_code[0];
1582   1           BELL=0;  for(i=0;i<=100;i++) dmsec(1);  BELL=1;
1583   1      
1584   1      
1585   1              for(i=0;i<12;i++)
1586   1              {   //½øÐÐ³õÊ¼»¯,²¢ÏÔÊ¾  ATE0V0  = ATE0 ATV0
1587   2                      Send_AT_Command(TC35_INIT,ptr1_at,0);
1588   2                      if(ptr1_at[1]==0x0d&&ptr1_at[0]==0x30)
1589   2                      {  break;}
1590   2              else if(ptr1_at[receive_count-1]==0x0d&&ptr1_at[receive_count-2]=='0')
1591   2               {  break;}
1592   2                      else if(i>1)
1593   2                              { IO_IGT=0;
1594   3                                timer_S_cnt=0; while(timer_S_cnt<2);
1595   3                                      IO_IGT=1;
1596   3                                timer_S_cnt=0; while(timer_S_cnt<2);
1597   3                                      Send_AT_Command(TC35_INIT,ptr1_at,0);
1598   3              
1599   3                              }
1600   2              /*       if((i%4)==0)
1601   2                      {
1602   2                              IO_IGT=1;  //µã»ð
1603   2                      }
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 27  

1604   2                      else if((i%2)==0)
1605   2                      {
1606   2                              IO_IGT=0;
1607   2                      }  */
1608   2      
1609   2                for(j=0;j<=20;j++)   dmsec(1);
1610   2      
1611   2          }
1612   1          if(i>=11)  //Ä£¿éÓÐÎÊÌâ
1613   1             goto at_eer;
1614   1      
1615   1      
1616   1              for(i=0;i<12;i++)
1617   1              {            //¶Á¿¨  AT+CPIN?
1618   2                      if(Send_AT_Command(AT_CPIN,ptr1_at,0))
1619   2                      {//ÈçÓÐÊÕµ½»ØÓ¦½øÐÐ·ÖÎöÊÕµ½µÄÐÅÏ¢,
1620   3                                      ptr1_at[receive_count]=0;
1621   3                                      if(strsearch("READY",ptr1_at)!=0)
1622   3                                      break;
1623   3                      }
1624   2                  timer_S_cnt=0; while(timer_S_cnt<2);
1625   2                                
1626   2              }
1627   1         if(i>=11)
1628   1          {
1629   2      at_eer:   Send_AT_Command(RESET_TC35,ptr1_at,0); //Ä£¿éÖØÆô  AT+CFUN=1,1
1630   2                  for(j=0;j<=2;j++)  for(i=0;i<=200;i++) dmsec(1);
1631   2                Send_AT_Command(AT_CMGF0,ptr1_at,0); //ATE0V0^SSMSS=1+CNMI=2,1
1632   2                    for(j=0;j<=20;j++)  for(i=0;i<=200;i++) dmsec(1);
1633   2          }
1634   1      
1635   1      
1636   1              Send_AT_Command(AT_CMGF0,ptr1_at,0);//ATE0V0^SSMSS=1+CNMI=2,1
1637   1              Send_AT_Command(AT_IPR,ptr1_at,0);//²¨ÌØÂÊ  AT+IPR=9600
1638   1              Send_AT_Command(AT_CGMM,ptr1_at,0);  //Ä£¿éÐÍºÅ AT+CGMM
1639   1              //_______________GPRS_________
1640   1              Send_AT_Command(AT_CIPHEAD,ptr1_at,0);  //ÉèÖÃ½ÓÊÕÊý¾ÝµÄIP Í·
1641   1          Send_AT_Command(AT_CDNSORIP,ptr1_at,"1"); //ÓòÃû·½Ê½
1642   1         // strcpy(ptr1_code,"\"222.73.49.102\"\x00");
1643   1         // Send_AT_Command(AT_CDNSCFG,ptr1_at,ptr1_code);   //ÓòÃû·þÎñÆ÷
1644   1              Send_AT_Command(AT_CIPSHUT,ptr1_at,0);   //¶Ï¿ªÁ¬½Ó
1645   1              //-----------------------
1646   1      
1647   1          for(j=0;j<=60;j++)  for(i=0;i<=200;i++) dmsec(1);
1648   1           BELL=0;  for(i=0;i<=100;i++) dmsec(1);  BELL=1;
1649   1      }
1650          
1651          
1652            /*
1653          *********************************************************************************************************
1654          ** º¯ÊýÃû³Æ Sys_Init()
1655          ** º¯Êý¹¦ÄÜ £º µ¥Æ¬»ú³õÊ¼»¯
1656          ** Èë¿Ú²ÎÊý £º
1657          **             È«¾Ö ±ä×î  timer_1S_cnt  receive_count
1658          ** ³ö¿Ú²ÎÊý :
1659          *********************************************************************************************************
1660          */
1661          
1662          void  Sys_Init(void)//»°»úÆô¶¯µÄ³õÊ¼»¯³ÌÐò,°üº¬¼üÅÌÓë¶¨Ê±Æ÷,´®¿ÚµÈ
1663          {
1664   1                              //TH0=(65536-46080)/256;//ÖØÐÂ×°Èë¶¨Ê±25mSµÄ³õÖµµ½TH0,TL0     56320
1665   1                              //TL0=(65536-46080)%256;
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 28  

1666   1                              //65536-(11.0592/12)*20MS*1000=To    18432     47104
1667   1                              //1ms¶¨Ê±
1668   1                              //11.0592/12 = 0.9216 M (¼ÇÊýÆµÂÊ)
1669   1                              //1ms¼ÇÊý 921.6´Î
1670   1                              //16Î» 2^16 - x = 922 x=64614 FC66
1671   1                              //¶¨Ê±Æ÷Àï²»¶Ï·Åfc66£¬²»ÓÃ»³ÒÉ51¶¨Ê±Æ÷µÃµ½µÄ 1msµÄ¾«È·ÐÔÂð
1672   1      
1673   1      
1674   1      
1675   1      
1676   1              TH0 = 0xB8;
1677   1              TL0 = 0x00; //20msµÄÊ±ÖÓ»ù×¼
1678   1      
1679   1        //´®¿ÚÖÐ¶Ï
1680   1          TI=0; RI=0;
1681   1          SCON=0x50;                  //Ñ¡ÓÃ·½Ê½1
1682   1          TMOD=0x20;
1683   1          TMOD = (TMOD & 0xf0) | 1;//MODE 1
1684   1         // TH1=0xe8;              //²¨ÌØÂÊÎª9600
1685   1         // TL1=0xe8;
1686   1         TH1=0xfd;              //²¨ÌØÂÊÎª9600
1687   1         TL1=0xfd;
1688   1          PCON=0x00;            //±¶Æµ0x80
1689   1          IE = 0xb0;          // EA XX ET2 ES ET0 EX0 ET1 EX1
1690   1          TR1=1;              //enable TIMER1
1691   1      
1692   1          ES=1;  //¿ª´®¿Ú¿ª¶Ï
1693   1          TR0=1; //´®¿Ú½ÓÊÕÖÐ¶Ï
1694   1          ET0=1;  //T0 ÖÐ¶Ï
1695   1          ET1=0;  // T1 ÖÐ¶Ï
1696   1          EA=1;
1697   1          P0=0xFF;
1698   1          P1=0xFF;
1699   1          P2=0xFF;
1700   1          P3=0xFF;
1701   1         // P4=0xff;
1702   1          timer_1S_cnt=0;receive_count=0;
1703   1          IO_IGT=1;
1704   1      
1705   1      
1706   1         #if   CPU_TYPE2==W78E58
                  //--------W78LE×¨ÓÃ-¿ªÆôÍâ²¿RAM-------------
                  CHPENR=0x87;
                  CHPENR=0x59;        //enable CHPCON write option
                  CHPCON=CHPCON|0x10; //enable AUX-RAM,use save programe data
                  //---------------------
                  #elif   CPU_TYPE2==STC89E58
1713   1            serial_port_two_initial();
1714   1      
1715   1         #endif
1716   1      }
1717           //======================================================
1718          //ÕâÀïÎªATÖ¸Áî´¦ÀíÇø,ËùÓÐµÄATÖ¸Áî¶¼ÔÚÕâÊ±¶Ôuart_buffÊý×é½øÐÐ¸³Öµ,²¢·¢ËÍ³öÈ¥,
1719          //-Õý³£Çé¿öÏÂ,ATÖ¸Áî·´»ØÒ²»áÔÚÕâÀï½ÓÊÕÍê
1720            //------------------------
1721            //-----------------------
1722            ///==========================================
1723          /*
1724          *********************************************************************************************************
1725          ** º¯ÊýÃû³Æ      £ºSend_AT_Command()
1726          ** º¯Êý¹¦ÄÜ              £º´®¿ÚATÖ¸Áî·¢ËÍÇ°´¦Àí,
1727          ** È«¾Ö±äÁ¿»òÊý×é:   receive_count ½ÓÊÕÖ¸Õë
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 29  

1728          ** Èë¿Ú²ÎÊý      £º type =ID,  ×ªÏòËùÓÐ  ATÖ¸Áî ×Ö·û´®
1729                                                  str_at- uart_buff   str_code -para_temp
1730          **                      *str_at=Òª¸´ÖÆµÄÄÚÈÝ/×ªATÖ¸Áî
1731          **                      *str_code Óë*str_atºÏ²¢µÄ²ÎÊý //ATÖ¸Áî²ÎÊý
1732          ** ³ö¿Ú²ÎÊý     £º  1- ³É¹¦,  0- Ê§°Ü
1733          *********************************************************************************************************
1734          */
1735          uchar  Send_AT_Command( uchar type,uchar *str_at ,uchar *str_code)      //·¢ËÍ£Á£ÔÖ¸Áî
1736          //²¦ºÅÊ±ºÅÂë·ÅÔÚphone.number
1737          //ÆäËûÓÃpara_temp
1738          {
1739   1              uint   i;
1740   1      
1741   1          switch(type)
1742   1          {
1743   2      
1744   2              case VOICE_DIAL:        //ÓïÒô²¦ºÅ
1745   2              strcpy(str_at,"ATD");
1746   2              strcat(str_at,str_code);
1747   2            // strcpy(uart_buff,"ATD10086;");
1748   2              strcat(uart_buff,";");
1749   2      
1750   2              break;
1751   2            case RESET_TC35:          //¸´Î»TC35
1752   2              strcpy(str_at,"ATE0V0+CFUN=0;+CFUN=1");
1753   2              break;
1754   2            case AT_CPIN:             //¼ì²éµ±Ç°ÊÇ·ñÒªÊäÈëPINÂë
1755   2              strcpy(str_at,"AT+CPIN?");
1756   2              break;
1757   2      
1758   2            case TC35_INIT:           //TC35³õÊ¼»¯ÃüÁî     ATE0 ATV0 ºÏÌå
1759   2              strcpy(str_at,"ATE0V0");
1760   2              break;
1761   2              //0D 0A 54 43 33 35 0D 0A
1762   2            case   AT_CGMM:   //Ä£¿é°æÐÍºÅ
1763   2              strcpy(str_at,"AT+CGMM");
1764   2              break;
1765   2      
1766   2            case AT_CMGF0:    // Ò²ÊÇºÏÌå×éºÏ  ATE0 ATV0 AT+CMGF=1 AT+CNMI=2,1
1767   2                strcpy(str_at,"ATE0V0+CMGF=0;+CNMI=2,1");
1768   2              break;
1769   2             case  AT_IPR:   // ²¨ÌØÂÊ 9600
1770   2              strcpy(str_at,"AT+IPR=9600&W"); break;
1771   2                      case CALL_ID:                   //¶ÁÀ´µçÏÔÊ¾
1772   2              strcpy(str_at,"AT+CLCC");
1773   2              break;
1774   2              case SMS_CMGL:          //É¾³ýÒ»¸ö¶ÌÐÅ
1775   2              // strcpy(uart_buff,"AT+CMGL=\"ALL\"");
1776   2              strcpy(str_at,"AT+CMGL=4");
1777   2            //  strcat(uart_buff,ptr);
1778   2              break;
1779   2            case HOOKOFF:                     //¹Ò»ú,Í£Ö¹Í¨»°
1780   2              strcpy(str_at,"ATH");
1781   2              break;
1782   2            case AT_CMGF1:    //SMS ½ÓÊÕ·½Ê½,
1783   2              strcpy(str_at,"ATE0V0+CMGF=1;+CNMI=2,1");
1784   2              break;
1785   2      
1786   2            case PHONE_WRITE:         //´æµç»°ºÅÂë
1787   2              strcpy(str_at,"AT+CPBW=");
1788   2              strcat(str_at,str_code);
1789   2              break;
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 30  

1790   2            case PHONE_READ:          //¶Áµç»°±¾
1791   2              strcpy(str_at,"AT+CPBR=");
1792   2              strcat(str_at, str_code);
1793   2              break;
1794   2            case SMS_CMGR:            //¶ÁÒ»¸ö¶ÌÐÅ
1795   2              strcpy(str_at,"AT+CMGR=");
1796   2              strcat(str_at,str_code);
1797   2              break;
1798   2             case SMS_CMGS:           //Ð´Ò»¸ö¶ÌÐÅ
1799   2              strcpy(str_at,"AT+CMGS=");    //AT+CMGS= "13818120592"
1800   2              strcat(str_at,str_code);
1801   2      
1802   2              break;
1803   2             case SMS_CMGD:           //É¾³ýÒ»¸ö¶ÌÐÅ
1804   2              strcpy(str_at,"AT+CMGD=");
1805   2              strcat(str_at,str_code);
1806   2              break;
1807   2             case  CMGS_MUB:    //·¢±¨¾¯¶ÌÐÅÄÚÈÝ
1808   2              strcpy(str_at,str_code);
1809   2               break;
1810   2             case AT_CPMS:
1811   2               strcpy(str_at,"ATE0V0+CPMS=\x22SM\x22");
1812   2              break;  //AT_CPMS
1813   2             case PICK_UP:         //Õª»ú
1814   2                  strcpy(str_at,"ATA");
1815   2           //----------------------------------------------------
1816   2            //--------------------------------------------------------
1817   2      
1818   2               case AT_COLP:          //µç»°·½Ê½
1819   2              strcpy(str_at,"AT+COLP=1");
1820   2              break;
1821   2                   case AT_CLTS:              //¼ì²éµ±Ç°ÊÇ·ñÒªÊäÈëPINÂë
1822   2              strcpy(str_at,"AT+CLTS");
1823   2              break;
1824   2      
1825   2              case AT_CIPCLOSE:            //    AT+CIPCLOSE ¹Ø±ÕTCP »òUDP Á¬½Ó
1826   2                 strcpy(str_at,"ATE0V0+CIPCLOSE");
1827   2                 break;
1828   2               case AT_CIPSHUT:            // AT+CIPSHUT ¹Ø±ÕÒÆ¶¯³¡¾°
1829   2                    strcpy(str_at,"AT+CIPSHUT");
1830   2                 break;
1831   2             case AT_CLPORT:            // AT+CLPORT ÉèÖÃ±¾µØ¶Ë¿Ú
1832   2                 strcpy(str_at,"AT+CLPORT=");
1833   2                 strcat(str_at,str_code);
1834   2                break;
1835   2            case AT_CSTT:       //AT+CSTT Æô¶¯ÈÎÎñ²¢ÉèÖÃAPN¡¢USER ID¡¢PASSWORD
1836   2                   strcpy(str_at,"AT+CSTT=");
1837   2                 strcat(str_at,str_code);
1838   2                 break;
1839   2      
1840   2             case AT_CIICR:   // AT+CIICR ¼¤»îÒÆ¶¯³¡¾°
1841   2                   strcpy(str_at,"AT+CIICR");
1842   2                 break;
1843   2              case AT_CIFSR:  //AT+CIFSR »ñµÃ±¾µØIP µØÖ·
1844   2                 strcpy(str_at,"AT_CIFSR");
1845   2                 break;
1846   2             case AT_CDNSGIP: //AT+CDNSGIP ÓòÃû½âÎö
1847   2                strcpy(str_at,"AT+CDNSGIP=");
1848   2                 strcat(str_at,str_code);
1849   2                 break;
1850   2             case AT_CDNSCFG:   //AT+CDNSCFG ÅäÖÃDNS
1851   2                   // strcpy(str_at,"AT+CDNSCFG=\"202.105.21.217\"");
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 31  

1852   2                 //  strcpy(str_at,"AT+CDNSCFG=\"222.73.49.102\"");
1853   2                   strcpy(str_at,"AT+CDNSCFG=");
1854   2                   strcat(str_at,str_code);
1855   2                   break;
1856   2      
1857   2              case AT_CDNSORIP:  //AT+CDNSORIP ÉèÖÃÁ¬½ÓSERVER ¶ËÎªIP µØÖ·»¹ÊÇÓòÃû 1 ±íÊ¾ÊÇÓòÃû
1858   2                   strcpy(str_at,"AT+CDNSORIP=");
1859   2                   strcat(str_at,str_code);
1860   2                   break;
1861   2              case AT_CIPHEAD:      //AT+CIPHEAD ÉèÖÃ½ÓÊÕÊý¾ÝµÄIP Í·
1862   2                   strcpy(str_at,"AT+CIPHEAD=1;+CIPFLP=1;+CIPATS=1,50");
1863   2                  // strcat(uart_buff,&str_code);
1864   2                   break;
1865   2              case AT_CIPATS:        //AT+CIPATS ÉèÖÃ×Ô¶¯·¢ËÍÊ±¼ä
1866   2                  strcpy(str_at,"AT+CIPATS=1,50");
1867   2                 //  strcat(uart_buff,str_code);
1868   2                   break;
1869   2              case  AT_CIPSEND :    //  GPRS ·¢ËÍ
1870   2                  strcpy(str_at,"AT+CIPSEND");
1871   2                  break;
1872   2             case AT_CIPSERVER:  //AT+CIPSERVER ÅäÖÃÎª·þÎñÆ÷
1873   2                 strcpy(str_at,"AT+CIPSERVER");
1874   2                  break;
1875   2             case AT_CIPCSGP:  //  AT+CIPCSGP ÉèÖÃÎªCSD »òGPRS Á¬½Ó
1876   2                   strcpy(str_at,"AT+CIPCSGP=");
1877   2                   strcat(str_at,str_code);
1878   2                   break;
1879   2            case AT_CIPCCON: // AT+CIPCCON ÉèÖÃµ±Ç°Á¬½Ó ·µ»Ø1 ±íÊ¾µ±Ç°TCP Á¬½ÓµÄ·¢
1880   2                   strcpy(str_at,"AT+CIPCCON=");
1881   2                   strcat(str_at,str_code);   //AT+CIPSHUT
1882   2                   break;
1883   2      
1884   2             case AT_CIPSTART: //  //AT+CIPSTART   Á¬½Ó GPRS TCp OR UDP
1885   2                   strcpy(str_at,"AT+CIPSTART=");//AT+CIPSTART="TCP","llx1.xicp.net","8080"
1886   2                   strcat(str_at,str_code);
1887   2                   break;
1888   2            case AT_CIPDPDP:    //AT+CIPDPDP ÉèÖÃÍøÂç×´Ì¬¼ì²âµÄÊ±¼ä¼ä¸ô
1889   2                  strcpy(str_at,"AT+CIPDPDP=0");
1890   2      
1891   2                   break;
1892   2                  // AT+CIPSTATUS
1893   2               case AT_CIPSTATUS:
1894   2                  strcpy(str_at,"AT+CIPSTATUS");
1895   2      
1896   2                   break;
1897   2               //----------------------------------------------------------
1898   2      
1899   2           //-----------------------------------------------
1900   2            case AT_COMMAND:
1901   2              break;
1902   2            default:
1903   2              receive_count=0;
1904   2              return(TRUE);
1905   2          }
1906   1          ES=1;
1907   1          strcat(str_at,"\x0d\x00");//ÔÚÃüÁîºó¼ÓÈëCR
1908   1          RI=0;                                       //Çå³ý½ÓÊÕ±êÖ¾
1909   1          TI=0;
1910   1         //------------------------------
1911   1          for(i=0;i<254;i++)
1912   1              {       if(str_at[i]==0) break;
1913   2      
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 32  

1914   2                      SBUF=str_at[i];
1915   2                      while(!TI);
1916   2                      TI=0;
1917   2                      if(str_at[i]==0x1a)  break;
1918   2              }
1919   1         //---------------------
1920   1         receive_count=0;
1921   1         str_at[0]=0; str_at[1]=0;str_at[2]=0;
1922   1         i=0;
1923   1         do{
1924   2             dmsec(10);
1925   2             if(receive_count>1)
1926   2             {        dmsec(1000);
1927   3                      //dmsec(100);
1928   3                  break;
1929   3             }
1930   2        #if   CPU_TYPE2==W78E58
                          }while(i++<1000);
                 #elif  CPU_TYPE2==STC89E58
1933   2                  }while(i++<1800);
1934   1        #endif
1935   1      
1936   1      
1937   1        /*  for(i=0;i<=100;i++) dmsec(1);
1938   1          for(i=0;i<=250;i++)
1939   1          {    dmsec(5);
1940   1               if(str_at[receive_count-1]==0x0d)
1941   1               {  dmsec(10);
1942   1                  break;
1943   1               }
1944   1          } */
1945   1      
1946   1          return(TRUE);
1947   1      
1948   1      
1949   1      
1950   1      }
1951          
1952          /*************************************************************/
1953          /*
1954          *********************************************************************************************************
1955          ** º¯ÊýÃû³Æ      tel_diat()
1956          ** º¯Êý¹¦ÄÜ                  ²¦´òÇ°1¸öµç»°,Ê±¼äÉèÎª80Ãë,
1957          ** È«¾Ö±äÁ¿»òÊý×é:   receive_count ½ÓÊÕÖ¸Õë
1958          ** Èë¿Ú²ÎÊý      £º  ATÖ¸Áî ×Ö·û´®
1959                                                  str_at- uart_buff   str_code -para_temp
1960          **                      *str_at=Òª¸´ÖÆµÄÄÚÈÝ/×ªATÖ¸Áî
1961          **                      *str_code  ·¢ËÍµÄÄÚÈÝ
1962          ** ³ö¿Ú²ÎÊý     £º
1963          *********************************************************************************************************
1964          */
1965          
1966          void tel_diat(char* ptr1_at,char* ptr1_code)
1967          {    uchar ii,j,t,r=0;
1968   1         //¿ÉÒÔÓÃÒ»¸öµç»°
1969   1         //ÎªÃ»ÓÐ´òÍ¨µç»°Ê±×öÁÙÊ±´æ´¢  0000 0111, ¿ÉÒÔ²¦´ò3¸öµç»°,·Ö±ðÊÇ1,2,3
1970   1          t=0x01;  ii=0;
1971   1            do
1972   1              {   ii=ii+1;
1973   2                              if(ii>=3)  ii=0;   // ×î´óÖµ,²»ÄÜÆð¹ýÈý¸öµç»°
1974   2                              if(t==0)   return ; //ºÅÂëÈ«²¿²¦Íê·µ»Ø
1975   2      
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 33  

1976   2                              if(     (t>>ii-1)&0x01!=0)  //²étÎ»ÊÇ·ñÓÐ1
1977   2                              { read_tmp=ii; }
1978   2                              else  {           continue;  }
1979   2                              j=PHONE_RD(ptr1_at,ptr1_code,read_tmp);    //¶Áµç»°ºÅÂë
1980   2                  r++;
1981   2                              if(j>5)  //ÓÐºÅÂë»á´æÈë para_temp  ,jÊÇ´«À´µÄÖ¸Õë,Ö¸Ïòpara_tempÀïµÄºÅÂëµÄ×îºóÒ»Î»+1
1982   2                              {
1983   3                                      ptr1_code[j++]=';';
1984   3                                      ptr1_code[j++]=0;
1985   3                                      ptr1_code[j++]=0x00;
1986   3                    if(!Send_AT_Command(VOICE_DIAL,ptr1_at,ptr1_code)); //²¦ºÅ
1987   3                      {    //²¦ºÅµÈ´ý
1988   4                                              receive_count=0;
1989   4                                                      timer_S_cnt=0;
1990   4                                                      while(timer_S_cnt<40 )
1991   4                                                      {  if(((ptr1_at[0]=='0')||(ptr1_at[0]=='6'))&&ptr1_at[1]==0x0d)
1992   5                                                         break;
1993   5                                                      }
1994   4                                       }
1995   3                                         if((((ptr1_at[0]=='0')&&ptr1_at[1]==0x0d)))      //²¦ºÅ³É¹¦
1996   3                                         {
1997   4                                                       t&=~(1<<ii-1) ;  //Çåµô²¦ºÅ³É¹¦µÄºÅÂë
1998   4                                              receive_count=0;
1999   4                                                      timer_S_cnt=0;
2000   4                                                      while(timer_S_cnt<80)
2001   4                                                      {    if(!io_p00_on )
2002   5                                                               { io_p00_on=1; BELL=0;
2003   6                                                                 timercount=0;  while(timercount<10) watch_dog_clear;//
2004   6                                                                  BELL=1;
2005   6                                                                }
2006   5                                                                 if(!io_p02_on )
2007   5                                                               { io_p02_on=1; BELL=0;
2008   6                                                                 timercount=0;  while(timercount<10) watch_dog_clear;//
2009   6                                                                  BELL=1;
2010   6                                                                }
2011   5                                     else if(!io_p03_on) //°´¼ü ¹Ò»ú
2012   5                                                              { io_p03_on=1;
2013   6                                                                 break;
2014   6                                                               }
2015   5                                                       };//µÈ´ý¹Ò»ú
2016   4                                   Send_AT_Command(HOOKOFF,ptr1_at,0);  //×Ô¶¯¹Ò»ú
2017   4                                   if(t==0)   return ; //ÄÚÈÝ¿Õ·µ»Ø
2018   4                                          }
2019   3      
2020   3      
2021   3                                        Send_AT_Command(HOOKOFF,ptr1_at,0); //¹Ò»úÖØ²¦
2022   3      
2023   3      
2024   3                        }
2025   2      
2026   2      
2027   2      
2028   2                      }while(r<30); //×î´ó²¦ºÅ´ÎÊý
2029   1      
2030   1      
2031   1      }
2032          /*************************************************************/
2033          
2034           /*
2035          *********************************************************************************************************
2036          ** º¯ÊýÃû³Æ GPS_READ()
2037          ** º¯Êý¹¦ÄÜ £º GPSÊý¾Ý¶ÁÈ¡
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 34  

2038          ** Èë¿Ú²ÎÊý £ºptr1_at --uart_buff ATÖ¸Áî·¢ËÍÓÃ ptr1_code -para_temp ²ÎÊýÄÚÈÝ
2039                         id   idÎª0ÊÇ×Ô¼º¶¨ÒåµÄÒ»ÖÖ¸ñÊ½·¢ËÍ ,Îª1ÊÇ±ê×¼Ô­Ê¼¸ñÊ½·¢ËÍ
2040          **             È«¾Ö ±ä×î    ptr1_at, uart_buff, receive_count
2041          
2042          ** ³ö¿Ú²ÎÊý :
2043          *********************************************************************************************************
2044          */
2045          
2046          void GPS_READ(char* ptr1_at,char* ptr1_code,char* ptr_tel,uchar id)
2047          {   // uchar idata ptr_tmp[32];
2048   1               uint y;
2049   1               uchar  i,j,t,r,x;
2050   1          // LCD_INT();
2051   1      
2052   1               GPS_ON=0;
2053   1              for(x=0;x<=10;x++)
2054   1              {
2055   2                 y=0;
2056   2                 receive_count=0;
2057   2                  do{
2058   3                 dmsec(3);
2059   3                if(receive_count>1)
2060   3                {     dmsec(50);
2061   4                  break;
2062   4                }
2063   3              }while(y++<1200);
2064   2              //---$GPRMC,020041.000,V,3112.1447,N,12139.3450,E,1.25,282.95,050309,,,E*7A
2065   2              //µÃµ½´úÂë, V,Êý¾ÝÊÇ·ñÓÐÐ§   3112.1447,N ½øÐÐ×ª»»Í¨ÓÃÂë
2066   2               //ÆäÖÐ3112¸Ä³É31 12²»±ä  1447Òª×ª»»³É1447*6/10= 0868
2067   2                 if(j=strsearch("$GPRMC,",ptr1_at))
2068   2                 {  j=j+5;//Ö¸ÏòÊ±¼ä
2069   3                     t=0;
2070   3                     do{
2071   4                        j++;
2072   4                        if(ptr1_at[j]==',')//½áÊø
2073   4                         break;
2074   4                     }while(t++<13);
2075   3                j++;//A»òV  AÎªÓÐÐ§
2076   3                t=0;
2077   3                ptr_tel[t++] =ptr1_at[j++];
2078   3              //---------------------------
2079   3                //j++;//Ö¸Ïò Î³¶È
2080   3                 ptr_tel[t++] =ptr1_at[j++];//,
2081   3      
2082   3                do{
2083   4                        ptr_tel[t++]=ptr1_at[j];
2084   4                        j++;
2085   4                        if(ptr1_at[j]==',')//½áÊø
2086   4                         break;
2087   4                     }while(t<13);
2088   3                   //  ptr_tel[t++]='-';
2089   3      
2090   3            //--------Î³¶È°ëÇòN(±±°ëÇò)»òS(ÄÏ°ëÇò)---------------------
2091   3                 // j++;//Ö¸Ïò
2092   3                 ptr_tel[t++]=ptr1_at[j++];    //ÄÚÈÝÊÇ ","
2093   3                 //--------------------------------
2094   3                 ptr_tel[t++]=ptr1_at[j++];   //ÄÚÈÝÊÇ N»òS
2095   3                 //-------------------Èý¸ö¿Õ¸ñ,×Ô¼º¼ÓµÄ,ÎªÁËÏÔÊ¾ÓÃ-----------------
2096   3                 ptr_tel[t++]=' '; ptr_tel[t++]=' ';ptr_tel[t++]=' ';
2097   3                // ptr_tel[t++]=0;
2098   3                //  PLAY_LCD(0,0,ptr_tel); //µÚÒ»ÐÐÏÔÊ¾
2099   3            //---------------------------------
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 35  

2100   3                 j++;//Ö¸Ïò ¾­¶È
2101   3               // t=0;
2102   3               r=0;
2103   3                do{
2104   4                        ptr_tel[t++]=ptr1_at[j];
2105   4                        j++;
2106   4                        if(ptr1_at[j]==',')//½áÊø
2107   4                         break;
2108   4                     }while(r++<11);
2109   3                    // ptr_tel[t++]='-';
2110   3      
2111   3            //--------¾­¶È°ëÇòE(¶«¾­)»òW(Î÷¾­) )---------------------
2112   3                  //  j++;//Ö¸Ïò
2113   3                    ptr_tel[t++]=ptr1_at[j++];  //ÄÚÈÝÊÇ ","
2114   3                  //-------------------
2115   3                   ptr_tel[t++]=ptr1_at[j++];   //ÄÚÈÝÊÇ E»òW
2116   3                  //========
2117   3                // ptr1_code[t++]=ptr1_at[j++];
2118   3                 //ptr_tel[t++]=' '; ptr_tel[t++]=' '; ptr_tel[t++]=' ';
2119   3                //----------------------------
2120   3                //-----------------------------
2121   3                 ptr_tel[t++]=0;
2122   3               //    PLAY_LCD(0,0,ptr_tel);  //ÏÔÊ¾´úÂë
2123   3      
2124   3           if(id==0)     //×Ô¼º¶¨Òå¸ñÊ½  V,3112.1447,N,12139.3450,E,
2125   3           {
2126   4            //------------------------------------------------
2127   4            //-- ¿ÉÒÔ½øÐÐÁ½ÖÖGPS Ð­Òé×ª»» ,-------------------------
2128   4            //------------------------------------------------
2129   4               //V,3112.1447,N  ±ä³ÉN31 12'14,47'
2130   4               //  12139.3450,E  ±ä³ÉE121 39'34.50'
2131   4                  i=0; t=0;
2132   4                              //----------------
2133   4                              ptr1_code[i++]=ptr_tel[t++];//V
2134   4                              ptr1_code[i++]=',';
2135   4                              //-----------------
2136   4                              i++;  //2 ÓÃÀ´·Å NÎ»ÖÃ
2137   4                              t++;
2138   4                              //-----------------
2139   4                              //½øÐÐÎ»ÊýËø¶¨,ÓÐËÄÎ»Óë5Î»Ö®·Ö
2140   4                  if(ptr_tel[t+4]=='.')   //  4Î»
2141   4                  {          //3112ËÄÎ»  ¸Ä³É 31 12
2142   5                    ptr1_code[i++]=ptr_tel[t++];//
2143   5                    ptr1_code[i++]=ptr_tel[t++];//
2144   5                    ptr1_code[i++]=',';//
2145   5                    ptr1_code[i++]=ptr_tel[t++];//
2146   5                    ptr1_code[i++]=ptr_tel[t++];//
2147   5                  }
2148   4                  else   //5Î»
2149   4                  {
2150   5                   ptr1_code[i++]=ptr_tel[t++];//
2151   5                    ptr1_code[i++]=ptr_tel[t++];//
2152   5                    ptr1_code[i++]=ptr_tel[t++];//
2153   5                    ptr1_code[i++]=',';//
2154   5                    ptr1_code[i++]=ptr_tel[t++];//
2155   5                    ptr1_code[i++]=ptr_tel[t++];//
2156   5                  }
2157   4                  t++;
2158   4                   ptr1_code[i++]=',';//.ºÅ
2159   4                //-------1447Òª×ª»»³É1447*6/10= 0868--------×ª»»-----------
2160   4                //ÏÈ×ª»»³É16½øÖÆ,Ö÷ÒªÊÇºÃ³Ë³ý
2161   4                ////------ËÄÎ»------------
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 36  

2162   4                              y=ptr_tel[t++]-0x30;
2163   4                              y=y*10;
2164   4                              y=y+ptr_tel[t++]-0x30;
2165   4                              y=y*10;
2166   4                              y=y+ptr_tel[t++]-0x30;
2167   4                              y=y*10;
2168   4                  y=y+ptr_tel[t++]-0x30;
2169   4      
2170   4                 y=y*6;
2171   4                 y=y/10;  //µÃµ½ÕûÊý
2172   4                 //---------------------------
2173   4      
2174   4                        // yy= yy%10000;
2175   4                        r= y/100 ;
2176   4      
2177   4                        ptr1_code[i++]=(r/10)+0x30;
2178   4                        ptr1_code[i++]=(r%10)+0x30;
2179   4                        ptr1_code[i++]=',';
2180   4                        r= y%100;
2181   4                        ptr1_code[i++]=(r/10)+0x30;
2182   4                        ptr1_code[i++]=(r%10)+0x30;
2183   4                        ptr1_code[i++]=',';
2184   4              //----------------------------------------------
2185   4                    t++;  //,ºÅ²»ÐÐ
2186   4                    ptr1_code[2]=ptr_tel[t++];   //3479
2187   4                  //-----------------------
2188   4                  //ÌøÏß Èý¸ö¿Õ¸ñ
2189   4                   t=t+3;
2190   4      
2191   4                  ////V,3112.1447,N   12139.3450,E
2192   4                   j=i;
2193   4                   i++;//ÎªÁË´æE
2194   4                              if(ptr_tel[t+4]=='.')   //  4Î»
2195   4                  {          //3112ËÄÎ»  ¸Ä³É 31 12
2196   5                    ptr1_code[i++]=ptr_tel[t++];//
2197   5                    ptr1_code[i++]=ptr_tel[t++];//
2198   5                    ptr1_code[i++]=',';//
2199   5                    ptr1_code[i++]=ptr_tel[t++];//
2200   5                    ptr1_code[i++]=ptr_tel[t++];//
2201   5                  }
2202   4                  else   //5Î»
2203   4                  {
2204   5                   ptr1_code[i++]=ptr_tel[t++];//
2205   5                    ptr1_code[i++]=ptr_tel[t++];//
2206   5                    ptr1_code[i++]=ptr_tel[t++];//
2207   5                    ptr1_code[i++]=',';//
2208   5                    ptr1_code[i++]=ptr_tel[t++];//
2209   5                    ptr1_code[i++]=ptr_tel[t++];//
2210   5                  }
2211   4                  t++;
2212   4                   ptr1_code[i++]=',';//.ºÅ
2213   4                //-------1447Òª×ª»»³É1447*6/10= 0868--------×ª»»-----------
2214   4                //ÏÈ×ª»»³É16½øÖÆ,Ö÷ÒªÊÇºÃ³Ë³ý
2215   4                ////------ËÄÎ»------------
2216   4                              y=ptr_tel[t++]-0x30;
2217   4                              y=y*10;
2218   4                              y=y+ptr_tel[t++]-0x30;
2219   4                              y=y*10;
2220   4                              y=y+ptr_tel[t++]-0x30;
2221   4                              y=y*10;
2222   4                  y=y+ptr_tel[t++]-0x30;
2223   4                   y=y*6;
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 37  

2224   4                 y=y/10;  //µÃµ½ÕûÊý3497
2225   4                 //---------------------------
2226   4      
2227   4                        // yy= yy%10000;
2228   4                        r= y/100 ;
2229   4      
2230   4                        ptr1_code[i++]=(r/10)+0x30;
2231   4                        ptr1_code[i++]=(r%10)+0x30;
2232   4                        ptr1_code[i++]=',';
2233   4                        r= y%100;
2234   4                        ptr1_code[i++]=(r/10)+0x30;
2235   4                        ptr1_code[i++]=(r%10)+0x30;
2236   4                        ptr1_code[i++]=',';
2237   4              //----------------------------------------------
2238   4                      t++;  //,ºÅ²»ÐÐ
2239   4                    ptr1_code[j]=ptr_tel[t++];
2240   4                    ptr1_code[i++]=0;
2241   4              //-----------------------
2242   4             }
2243   3             else  //±ê×¼¸ñÊ½Ô­Ê¼Êý¾Ý  V,3112.1447,N,12139.3450,E,
2244   3             {
2245   4                  strcpy(ptr1_code,ptr_tel);
2246   4                //PLAY_LCD(0,0,ptr1_code);
2247   4               /*  timercount=0; while(timercount<200) ;
2248   4                 timercount=0; while(timercount<200) ;
2249   4                 timercount=0; while(timercount<200) ;
2250   4                  PLAY_LCD(0,0,"                                     ");
2251   4                 PLAY_LCD(0,0,ptr_tel);  */
2252   4              }
2253   3              break;
2254   3               }
2255   2      
2256   2      
2257   2      
2258   2              //  PLAY_LCD(0,1,ptr_tel);
2259   2          }
2260   1        //-------------------------------------
2261   1      
2262   1           GPS_ON=1;
2263   1      
2264   1      }
2265          
2266          
2267          
2268          /*
2269          *********************************************************************************************************
2270          ** º¯ÊýÃû³Æ      GPRS_SEND()
2271          ** º¯Êý¹¦ÄÜ               TCP/UDPÊý¾Ý·¢ËÍ
2272          ** È«¾Ö±äÁ¿»òÊý×é:   receive_count ½ÓÊÕÖ¸Õë
2273          ** Èë¿Ú²ÎÊý      £º  ATÖ¸Áî ×Ö·û´®
2274                                                  str_at- uart_buff   str_code -para_temp
2275          **                      *str_at=Òª¸´ÖÆµÄÄÚÈÝ/×ªATÖ¸Áî
2276          **                      *str_code  ·¢ËÍµÄÄÚÈÝ
2277          ** ³ö¿Ú²ÎÊý     £º 1-³É¹¦      0-Ê§°Ü
2278          *********************************************************************************************************
2279          */
2280          /**************************************************************/
2281          //----------------------------------
2282          //------GPRS·¢ËÍ---------------
2283          uchar GPRS_SEND(char* ptr1_at,char* ptr1_code)
2284          {  //uchar  i ;
2285   1      
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 38  

2286   1                Send_AT_Command(AT_CIPSEND,ptr1_at,0);      //·¢ËÍGPRSÊý¾Ý
2287   1                timercount=0; while(timercount<1);
2288   1      
2289   1                if(ptr1_at[0]=='4'&&ptr1_at[0]==0x0d)
2290   1                  return(0);
2291   1            strcat(ptr1_code,"\x1a\x00");
2292   1            Send_AT_Command(CMGS_MUB,ptr1_at,ptr1_code);
2293   1      
2294   1            timer_S_cnt=0; while(timer_S_cnt<5)
2295   1            {
2296   2               if( strsearch("CLOSE",ptr1_at))  //SEND OK
2297   2                  return(0);
2298   2               else if( strsearch("SEND OK",ptr1_at))  //SEND OK
2299   2                  return(1);
2300   2             }
2301   1            return(0);
2302   1      
2303   1      }
2304          
2305          //-----------------
2306          
2307          /*
2308          *********************************************************************************************************
2309          ** º¯ÊýÃû³Æ      GPRS_SET()
2310          ** º¯Êý¹¦ÄÜ             GPRSÖÐµÄ TCP Ð­ÒéÁ¬½Ó   ÕâÀïÓÃµÄÊÇÓòÃû·½Ê½Á¬½Ó
2311          ** È«¾Ö±äÁ¿»òÊý×é:   receive_count ½ÓÊÕÖ¸Õë
2312          ** Èë¿Ú²ÎÊý      £º  ATÖ¸Áî ×Ö·û´®
2313                                                  str_at- uart_buff   str_code -para_temp
2314          **                      *str_at=Òª¸´ÖÆµÄÄÚÈÝ/×ªATÖ¸Áî
2315          **                      *str_code ATÖ¸ÁîµÄ²ÎÊý»òÆäËü²ÎÊý
2316          ** ³ö¿Ú²ÎÊý     £º
2317          *********************************************************************************************************
2318          */
2319          uchar  GPRS_SET(char* ptr1_at,char* ptr1_code,char* ptr_tel)
2320          {
2321   1      
2322   1      //        uchar i;
2323   1      
2324   1               Send_AT_Command(AT_CIPSTATUS,ptr1_at,0); //²éÑ¯
2325   1                timercount=0; while(timercount<1);
2326   1              if(ptr1_at[receive_count-5]==0x0d&&ptr1_at[receive_count-4]==0x0a
2327   1                 &&ptr1_at[receive_count-3]=='8'
2328   1                &&ptr1_at[receive_count-2]==0x0d&&ptr1_at[receive_count-1]==0x0a
2329   1               )
2330   1               {   return(1) ;   //Èç¹ûÔÚÍø²»ÓÃÁ¬½Ó
2331   2                }
2332   1               else    //Ã»ÓÐ ÔÚÍø
2333   1               {
2334   2              Send_AT_Command(AT_CIPHEAD,ptr1_at,0);
2335   2                      Send_AT_Command(AT_CIPCLOSE,ptr1_at,0); //¹Ø±ÕGPRS
2336   2                      timercount=0; while(timercount<1);
2337   2                      /***********************************/
2338   2                       if(ptr_tel[0]!=0)  //ÓòÃû·½Ê½
2339   2                       {
2340   3                              Send_AT_Command(AT_CDNSORIP,ptr1_at,"1"); //ÓòÃû·½Ê½
2341   3                      //strcpy(ptr_tel,"\"222.73.49.102\"\x00");
2342   3                       //ÓòÃû·þÎñÆ÷
2343   3                      //Send_AT_Command(AT_CDNSCFG,ptr1_at,ptr_tel);
2344   3               }
2345   2              else  //IP·½Ê½
2346   2                Send_AT_Command(AT_CDNSORIP,ptr1_at,"0"); //IP·½Ê½
2347   2               //--------------------
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 39  

2348   2                      //---------------------------------------
2349   2                      //  strcpy(ptr1_code,"\"TCP\",\"llx1.xicp.net\",\"1001\"\x00");
2350   2                       //AT+CIPSTART="TCP","124.78.41.17","8080"
2351   2      
2352   2               Send_AT_Command(AT_CIPSTART,ptr1_at,ptr1_code); //Á¬½ÓGPRS
2353   2               /**************************************/
2354   2              //µÈ´ýÁ¬Íø³É¹¦±¨¸æ
2355   2                       timer_S_cnt=0; while(timer_S_cnt<60)
2356   2                      {
2357   3                         if(ptr1_at[receive_count-5]==0x0d&&ptr1_at[receive_count-4]==0x0a
2358   3                              &&ptr1_at[receive_count-3]=='8'
2359   3                              &&ptr1_at[receive_count-2]==0x0d&&ptr1_at[receive_count-1]==0x0a
2360   3                                      )    //Á¬½á³É¹¦
2361   3                 {
2362   4                      timer_S_cnt=0; return(1) ;
2363   4                 }
2364   3      
2365   3                 else
2366   3                if (ptr1_at[receive_count-5]==0x0d&&ptr1_at[receive_count-4]==0x0a
2367   3                  &&ptr1_at[receive_count-3]<='7'
2368   3                              &&ptr1_at[receive_count-2]==0x0d&&ptr1_at[receive_count-1]==0x0a
2369   3                               )    //Ê§°ÜÍË³ö
2370   3                              {  Send_AT_Command(AT_CIPCLOSE,ptr1_at,0); return(0) ;  }
2371   3                       if(ptr1_at[receive_count-2]=='4'&&ptr1_at[receive_count-1]==0x0d)
2372   3                        {
2373   4                             Send_AT_Command(AT_CIPCLOSE,ptr1_at,0);  return(0) ;
2374   4                        }
2375   3                }
2376   2            if(timer_S_cnt!=0) {Send_AT_Command(AT_CIPCLOSE,ptr1_at,0); return(0) ;  } //Ê§°Ü·µ»Ø
2377   2              }
2378   1      
2379   1      
2380   1      
2381   1      }
2382          
2383          /*
2384          *********************************************************************************************************
2385          ** º¯ÊýÃû³Æ      GPRS_UP()
2386          ** º¯Êý¹¦ÄÜ             GPRSÖÐµÄ TCP Ð­ÒéÁ¬½Ó   ÕâÀïÓÃµÄÊÇÓòÃû·½Ê½Á¬½Ó
2387          ** È«¾Ö±äÁ¿»òÊý×é:   receive_count ½ÓÊÕÖ¸Õë
2388          ** Èë¿Ú²ÎÊý      £º  ATÖ¸Áî ×Ö·û´®
2389                                                  str_at- uart_buff   str_code -para_temp IP¼°¶Ë¿Ú
2390                                                  ptr_tel  ÓòÃû
2391          **                      *str_at=Òª¸´ÖÆµÄÄÚÈÝ/×ªATÖ¸Áî
2392          **                      *str_code ATÖ¸ÁîµÄ²ÎÊý»òÆäËü²ÎÊý
2393          ** ³ö¿Ú²ÎÊý     £º
2394          *********************************************************************************************************
2395          */
2396          /***********************************************/
2397          //-------GPRSÁªÍø¼°´¦Àí------------------------------------
2398          //               uart_buff para_temp   receive_count
2399          ////char* ptr1_at,char* ptr1_code, char* ptr_tel
2400          uchar  GPRS_UP(char* ptr1_at,char* ptr1_code,char* ptr_tel)
2401          {
2402   1              uchar i,j;
2403   1         // GPRS TCP»òUDPÁ¬½Ó,±¾»ú²ÉÓÃTCP
2404   1              i=GPRS_SET(ptr1_at,ptr1_code, ptr_tel);
2405   1          if(i==0)  return(0) ;//Ê§°Ü·µ»Ø
2406   1              /**********************************************/
2407   1              //  ÒÔÏÂÎªÁ¬½Ó³É¹¦ºó´¦Àí
2408   1              /************************************************/
2409   1        //--------------------------------
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 40  

2410   1               strcpy(ptr1_code,"SIM300 OK!");  //Í¨ÖªµÀ¶Ô·½ÒÑ¾­Á¬½Ó
2411   1               if(GPRS_SEND(ptr1_at,ptr1_code)==0)  //·¢ËÍGPRSÊý¾Ý
2412   1                          i=0;
2413   1               //    return ;     //Ê§°ÜÍË³ö
2414   1          //---------------------------
2415   1               P0=0;
2416   1             timer_S_cnt=0; while(timer_S_cnt<80) //ÁªÍøºó´¦Àí
2417   1             {
2418   2                if(receive_count>1) //ÊÕµ½¶Ô·½Êý¾Ý½øÐÐ´¦Àí
2419   2                {
2420   3                    timercount=0; while(timercount<2);
2421   3                    ptr1_at[receive_count]=0;
2422   3                    i=strsearch("+IPD",ptr1_at); //IPÍ·
2423   3                  //+IPD5:LED3N  +IPD10:12345LED3N
2424   3                  if(i)
2425   3                  {
2426   4                    receive_count=0;
2427   4                   //-------±¨ÎÄ³¤¶È,  ÕâÀïÌø¹ý--------------
2428   4                    i=i+3;
2429   4                    i++;
2430   4                    if(ptr1_at[i]==':')// :ºóÃæÊÇÄÚÈÝ
2431   4                    i++;
2432   4                    else i=i+2;
2433   4                    j=i;
2434   4                    //-ÏÂÃæGPRSÊý¾Ý´¦ÀíÇø------------
2435   4                 //---------LED2N LED3N LED4N LED5N LED6N LED7N--------------------------------
2436   4                         //         LED2F LED3F LED4F LED5F LED6F LED7F
2437   4                               if(ptr1_at[i]=='B'&&ptr1_at[i+1]=='E'&&ptr1_at[i+2]=='E'&&ptr1_at[i+3]=='P')
2438   4                 {                 timer_S_cnt=0;
2439   5                        BELL=0;
2440   5                                      for(i=0;i<4;i++)    //µÆÉÁÈýÏÂ
2441   5                              {  dmsec(100);
2442   6                               }
2443   5                                      BELL=1; //·äÃùÆ÷
2444   5                                       strcpy(ptr1_code,"BEEP OK!");
2445   5                       GPRS_SEND(ptr1_at,ptr1_code);
2446   5                 }
2447   4               //  else  if(strsearch1(i,"START",ptr1_at))
2448   4               else if(ptr1_at[i]=='S'&&ptr1_at[i+1]=='T'&&ptr1_at[i+2]=='A'
2449   4                        &&ptr1_at[i+3]=='R'&&ptr1_at[i+4]=='T')
2450   4      
2451   4                 {
2452   5                       IO_OUT=0; //¼ÌµçÆ÷ÎüºÏ
2453   5                                       strcpy(ptr1_code,"Relay ON OK!");
2454   5                       GPRS_SEND(ptr1_at,ptr1_code);  timer_S_cnt=0;
2455   5                 }
2456   4               //   else  if(strsearch1(i,"END",ptr1_at))
2457   4                else if(ptr1_at[i]=='E'&&ptr1_at[i+1]=='N'&&ptr1_at[i+2]=='D')
2458   4      
2459   4                 {
2460   5                       IO_OUT=1; //¼ÌµçÆ÷ÎüºÏ
2461   5                                       strcpy(ptr1_code,"Relay OFF OK!");
2462   5                       GPRS_SEND(ptr1_at,ptr1_code);   timer_S_cnt=0;
2463   5                 }
2464   4                else  if(strsearch1(i,"GPS",ptr1_at))
2465   4                 {
2466   5                       GPS_READ(ptr1_at,ptr1_code,ptr_tel,0);
2467   5      
2468   5                       GPRS_SEND(ptr1_at,ptr1_code);  timer_S_cnt=0;
2469   5                 }
2470   4                 /**********************************************/
2471   4                 //--------SIM300 OFF--        ¶Ô·½¹ØGPRS----------------
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 41  

2472   4                /**************************************************/
2473   4                 else if(ptr1_at[i]=='S'&&ptr1_at[i+1]=='I'&&ptr1_at[i+2]=='M'
2474   4                      &&ptr1_at[i+3]=='3'&&ptr1_at[i+4]=='0'&&ptr1_at[i+5]=='0'
2475   4                      && ptr1_at[i+6]==' '&&ptr1_at[i+7]=='O'&&ptr1_at[i+8]=='F'
2476   4                      &&ptr1_at[i+9]=='F' )
2477   4                                       {
2478   5                                                 Send_AT_Command(AT_CIPCLOSE,ptr1_at,0);
2479   5                                                         strcpy(ptr1_code,"SIM300 OFF OK!");
2480   5                                 GPRS_SEND(ptr1_at,ptr1_code);
2481   5                             Send_AT_Command(AT_CIPHEAD,ptr1_at,0);   timer_S_cnt=0;
2482   5                                                                    return(1) ;
2483   5                                       }
2484   4                              else {
2485   5                                      #if   CPU_TYPE2==STC89E58
2486   5                                          i=j;j=0;
2487   5                                          do{
2488   6                                             if(ptr1_at[i] ==0) break;
2489   6                                              pc_buff[j++]=  ptr1_at[i++];
2490   6      
2491   6                                          }while(j<=180);
2492   5                               pc_buff[j++]=0;
2493   5                                          // strcpy(pc_buff,ptr1_at);
2494   5                              //       strcat(pc_buff,"\x0d");
2495   5                                       send_UART_two(pc_buff);
2496   5                                         #endif
2497   5      
2498   5                                    receive_count=0;
2499   5                                }
2500   4      
2501   4                       }
2502   3      
2503   3                           else {
2504   4      
2505   4                                    receive_count=0;
2506   4                                }
2507   3      
2508   3      
2509   3      
2510   3              } /// ÊÕµ½µÄÊý¾Ý
2511   2            /*********************************************/
2512   2                       else if(!io_p00_on )   //Ó²¼þ
2513   2               { io_p00_on=1;   //ÖÐÎÄ D6D0CEC4
2514   3                  strcpy(ptr1_code,"\xD6\xD0\xCE\xC4 OUT2 OK!");
2515   3                  GPRS_SEND(ptr1_at,ptr1_code);
2516   3               }
2517   2               else if(!io_p02_on) //Ó²¼þ
2518   2                { io_p02_on=1;
2519   3                  strcpy(ptr1_code,"\xD6\xD0\xCE\xC4 OUT1 OK!");
2520   3                  GPRS_SEND(ptr1_at,ptr1_code);
2521   3               }
2522   2              else if(!io_p03_on) //Ó²¼þ
2523   2               { io_p03_on=1;
2524   3                 strcpy(ptr1_code,"SIM300 OFF OK!");
2525   3                 GPRS_SEND(ptr1_at,ptr1_code);
2526   3                      Send_AT_Command(AT_CIPCLOSE,ptr1_at,0); //¹Ø±ÕGPRS
2527   3                                       return(1) ;
2528   3               }
2529   2             #if   CPU_TYPE2==STC89E58
2530   2                             /* µÚ¶þ´®¿Ú ,¾ÍÊÇË«´®¿Úµ¥Æ¬»ú²ÅÓÐµÄ¿ØÖÆ*/
2531   2                                      else    if(pc_bit==1)
2532   2                                                 {    timercount=0; while(timercount<5);
2533   3                                                              pc_bit=0; pc_count=0;
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 42  

2534   3                                       timer_S_cnt=0;
2535   3      
2536   3                                 GPRS_SEND(ptr1_at,pc_buff);
2537   3                             Send_AT_Command(AT_CIPHEAD,ptr1_at,0);
2538   3      
2539   3                                                      for(i=0;i<=100;i++)
2540   3                                                      {
2541   4                                                          pc_buff[i]=0;
2542   4                                                      }
2543   3      
2544   3                                                 }
2545   2                   #endif
2546   2      
2547   2      
2548   2           /*****************************************/
2549   2               else  if(receive_count>10)
2550   2              {
2551   3                      receive_count=0;
2552   3              }
2553   2          }
2554   1      
2555   1          return(2) ;
2556   1      
2557   1      }
2558          /****************************************/
2559          /*
2560          // system_server
2561          #define SYS_PDU_1                                       1       //
2562          #define SYS_RING                                        2       //
2563          #define SYS_TEXT_1                                      3       //
2564          #define SYS_KEY_1                                               4       //
2565          #define SYS_SMSR                                        5       //
2566          #define SYS_KEY_2                                       6       //
2567          #define SYS_SMSS                                        7       //
2568          #define SYS_TEL                                         8    //
2569          #define SYS_DIAL                    9
2570          */
2571          /******************************************/
2572          void main(void)
2573          {
2574   1              uchar i;
2575   1              Sys_Init();
2576   1              Initialize_Model(uart_buff,para_temp);//½øÐÐ³õÊ¼»¯
2577   1              P0=0;
2578   1      
2579   1               system_server=SYS_SMSR;
2580   1              //-----------------------
2581   1              /*system_server=SYS_TEXT ;
2582   1              receive_count=0;
2583   1              timer_S_cnt=0; while(timer_S_cnt<15)*/
2584   1              //---------------------
2585   1                        strcpy(pc_buff,"SIM300 OK!");
2586   1                        strcat(pc_buff,"\x0d");
2587   1                        send_UART_two(pc_buff);
2588   1      
2589   1          //  p1_bit_on=p1_bit_off=p2_bit_on=p2_bit_off=0;
2590   1      
2591   1          pc_count=0;
2592   1              receive_count=0;
2593   1              sms_tmp=0;
2594   1          PT2272_BIT=0;PT2272_TMP=0;// ²ÎÊý³õÊ¼»¯
2595   1          io_p00_on=1;io_p02_on=1;io_p03_on=1;
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 43  

2596   1              io_p02_bit =0;
2597   1      
2598   1              while(1)
2599   1              {
2600   2      
2601   2                      //-----------²éÑ¯1µ½20ÌõÖÐµÄ¶ÌÐÅ,Ö»ÒªÓÐ¶ÌÐÅ¾Í´¦Àí------------------------------------------
2602   2                      if(system_server==SYS_SMSR)                     //¶Á1-20Ìõ¶ÌÐÅ
2603   2                              {
2604   3                      system_server=SYS_SMSR;
2605   3                                      i=read_sms(uart_buff,para_temp,TEL_temp,GPRS_TMP);
2606   3                                      if(i==0)
2607   3                                      {
2608   4                                          receive_count=0;   timercount=0; while(timercount<5);
2609   4                           receive_count=0;
2610   4                                      timer_S_cnt=0; while(timer_S_cnt<60)
2611   4                                      {
2612   5                                    //-----°´¼ü ºôÈë  ----------------
2613   5                                     i=P2_INIT() ;
2614   5                                     if(i!=0)
2615   5                                      {    system_server=i;
2616   6                                               break;
2617   6                                       }
2618   5                            //-------¶ÌÐÅ--------------
2619   5                                                 if(strsearch( "+CMTI:",uart_buff))
2620   5                                                   {  timercount=0; while(timercount<15);
2621   6                                                   break; }
2622   5      
2623   5                                              /*****Á÷Ë®Á÷Óë PT2272´¦Àí**********************/
2624   5                                               //  LED_1();
2625   5                           #if   CPU_TYPE2==STC89E58
2626   5                             /* µÚ¶þ´®¿Ú ,¾ÍÊÇË«´®¿Úµ¥Æ¬»ú²ÅÓÐµÄ¿ØÖÆ*/
2627   5                                                 if(pc_bit==1)
2628   5                                                 {    timercount=0; while(timercount<5);
2629   6                                                              pc_bit=0; pc_count=0;
2630   6                                   if((pc_buff[0]=='a'||pc_buff[0]=='A')&&pc_buff[1]==0x0d)
2631   6                                   {
2632   7                                        P0_1=1;
2633   7      
2634   7                                             strcpy(pc_buff,"OUT1 ON!");
2635   7                                                               strcat(pc_buff,"\x0d");
2636   7                                                       send_UART_two(pc_buff);
2637   7      
2638   7                                   }
2639   6                                   else
2640   6                                  if((pc_buff[0]=='b'||pc_buff[0]=='B')&&pc_buff[1]==0x0d)
2641   6                                  {
2642   7                                      P0_1=0;
2643   7      
2644   7                                           strcpy(pc_buff,"OUT1 OFF!");
2645   7                                                               strcat(pc_buff,"\x0d");
2646   7                                                              send_UART_two(pc_buff);
2647   7      
2648   7      
2649   7                                }
2650   6      
2651   6                                 if((pc_buff[0]=='c'||pc_buff[0]=='C')&&pc_buff[1]==0x0d)
2652   6                                  {
2653   7                                      P0_2=1;
2654   7                                      strcpy(pc_buff,"OUT2 ON!");
2655   7                                                      strcat(pc_buff,"\x0d");
2656   7                                                              send_UART_two(pc_buff);
2657   7      
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 44  

2658   7      
2659   7                                  }
2660   6      
2661   6      
2662   6                                   if((pc_buff[0]=='d'||pc_buff[0]=='D')&&pc_buff[1]==0x0d)
2663   6                                  {
2664   7                                      P0_2=0;
2665   7      
2666   7                                           strcpy(pc_buff,"OUT2 OFF!");
2667   7                                                               strcat(pc_buff,"\x0d");
2668   7                                                              send_UART_two(pc_buff);
2669   7      
2670   7      
2671   7                                  }
2672   6      
2673   6      
2674   6                                                      for(i=0;i<=100;i++)
2675   6                                                      {
2676   7                                                          pc_buff[i]=0;
2677   7                                                      }
2678   6      
2679   6                                                 }
2680   5                             #endif
2681   5      
2682   5      
2683   5                                      }
2684   4      
2685   4      
2686   4                                      }
2687   3      
2688   3      
2689   3                  }
2690   2              //------------ÒÔÏÂÊÇ¶ÌÐÅ´¦Àí-------------------------------------
2691   2                              // Ó²¼þÖÐ¶Ï´¦Àí Á¬GPRS ·þÎñÆ÷
2692   2                        else if(system_server==SYS_KEY_2)
2693   2      
2694   2                        {
2695   3                                      //   Á¬GPRS ·þÎñÆ÷    ÕâÀï¿ÉÄÜ¸ü¸Ä×Ô¼º µÄIP»òÓòÃû
2696   3                                 //-----------------ÓòÃû·½Ê½--ÓÃÏÂÃæÁ½Ìõ-----------------------
2697   3                       // LLXDZ.VICP.NET   ÓòÃû   1001 ¶Ë¿Ú
2698   3                                      //ÓòÃû¼°¶Ë¿Ú
2699   3                       //      strcpy(para_temp,"\"TCP\",\"LLXDZ.VICP.NET\",\"1001\"\x00");
2700   3                                  //»¨Éú¿ÇÓòÃû·þÎñÆ÷,Ìá¹©hificat.vicp.netÓòÃû
2701   3                       //      strcpy(GPRS_TMP,"\"222.73.49.102\"\x00");
2702   3      
2703   3                               ////-------------------------------------------
2704   3      
2705   3      
2706   3                                //---------------IP·½Ê½-ÓÃÏÂÃæÁ½Ìõ-------------------------
2707   3                                 //-    // 114.50.52   ÓòÃû   1001 ¶Ë¿Ú
2708   3                                      //58.60.207.182  ¶Ë¿Ú5005
2709   3                                      strcpy(para_temp,"\"TCP\",\"122.234.243.143\",\"1001\"\x00");
2710   3                                      GPRS_TMP[0]=0;
2711   3      
2712   3                                //Îª0 ²ÅÄÜ½øÈëIP·½Ê½Á¬½Ó
2713   3      
2714   3                              //----------------------------------------
2715   3      
2716   3      
2717   3                               GPRS_UP(uart_buff,para_temp,GPRS_TMP);
2718   3                           system_server=SYS_SMSR;
2719   3      
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 45  

2720   3                       }
2721   2                       // Ó²¼þÖÐ¶Ï´¦Àí   //·¢Ó¢ÎÄ
2722   2                       else if(system_server==SYS_KEY_1)
2723   2                        {             //int_p03(uart_buff,para_temp,TEL_temp);
2724   3                                    int_p02(uart_buff,para_temp,TEL_temp);
2725   3                                system_server=SYS_SMSR;
2726   3      
2727   3                              }
2728   2               //---------------------------------------------
2729   2                      //======== // //»ØÖÐÎÄ¶ÌÐÅ´¦Àí= ==========
2730   2                              else if(system_server==SYS_PDU_1)
2731   2                              {
2732   3                                       send_sms(uart_buff,para_temp,TEL_temp,smss_pud_1);
2733   3                                      system_server=SYS_SMSR;
2734   3                              }
2735   2      
2736   2               //-------------Ó¢ÎÄ¶ÌÐÅµÄ»Ø¸´---------------------------
2737   2                        else if(system_server==SYS_TEXT_1) //·¢ËÍ para_tempÀïµÄºÅÂë
2738   2                              {
2739   3                                       send_sms(uart_buff,para_temp,TEL_temp,smss_text_tmp);
2740   3                                      system_server=SYS_SMSR;
2741   3                              }
2742   2      
2743   2              //---------------//À´µç´¦Àí-------------------------
2744   2                 else if(system_server==SYS_RING)
2745   2                        {
2746   3                                       ring_auto(uart_buff,para_temp,TEL_temp);
2747   3                                       system_server=SYS_SMSR;
2748   3      
2749   3                    }
2750   2                 //-----------------//´òµç»°´¦Àí----------------------------
2751   2                   else if(system_server==SYS_DIAL)
2752   2                        {
2753   3                                 tel_diat(uart_buff,para_temp);
2754   3                                 system_server=SYS_SMSR;
2755   3                              }
2756   2            //---------------------------------------
2757   2      
2758   2              else  system_server=SYS_SMSR;
2759   2      
2760   2              }
2761   1      
2762   1      
2763   1      }
2764          
2765          
2766          
2767          
2768          
2769          
2770          
2771          
2772          
2773          
2774          
2775          
2776          
2777          
2778          
2779          
2780          
2781          
C51 COMPILER V7.50   CHESHI                                                                04/28/2011 20:15:05 PAGE 46  

2782          
2783          
2784          
2785          
2786          
2787          
2788          
2789          
2790          
2791          
2792          
2793          
2794          
2795          
2796          
2797          
2798          
2799          
2800          
2801          
2802          
2803          
2804          
2805          
2806          
2807          
2808          
2809          
2810          
2811          
2812          
2813          
2814          
2815          
2816          
2817          
2818          
2819          
2820          
2821          
2822          
2823          
2824          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =  14611    ----
   CONSTANT SIZE    =    885    ----
   XDATA SIZE       =    299    ----
   PDATA SIZE       =   ----     185
   DATA SIZE        =     12    ----
   IDATA SIZE       =    188      24
   BIT SIZE         =     18    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
